(()=>{var __webpack_modules__={4570:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" style="width:32px; height:32px;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>'},6199:t=>{t.exports='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 400 400" style="enable-background:new 0 0 400 400; width:32px; height:32px;" xml:space="preserve"><style type="text/css"> .st0{fill:#1DA1F2;} .st1{fill:#FFFFFF;} </style><g id="Dark_Blue"><path class="st0" d="M350,400H50c-27.6,0-50-22.4-50-50V50C0,22.4,22.4,0,50,0h300c27.6,0,50,22.4,50,50v300 C400,377.6,377.6,400,350,400z"></path></g><g id="Logo__x2014__FIXED"><path class="st1" d="M153.6,301.6c94.3,0,145.9-78.2,145.9-145.9c0-2.2,0-4.4-0.1-6.6c10-7.2,18.7-16.3,25.6-26.6 c-9.2,4.1-19.1,6.8-29.5,8.1c10.6-6.3,18.7-16.4,22.6-28.4c-9.9,5.9-20.9,10.1-32.6,12.4c-9.4-10-22.7-16.2-37.4-16.2 c-28.3,0-51.3,23-51.3,51.3c0,4,0.5,7.9,1.3,11.7c-42.6-2.1-80.4-22.6-105.7-53.6c-4.4,7.6-6.9,16.4-6.9,25.8 c0,17.8,9.1,33.5,22.8,42.7c-8.4-0.3-16.3-2.6-23.2-6.4c0,0.2,0,0.4,0,0.7c0,24.8,17.7,45.6,41.1,50.3c-4.3,1.2-8.8,1.8-13.5,1.8 c-3.3,0-6.5-0.3-9.6-0.9c6.5,20.4,25.5,35.2,47.9,35.6c-17.6,13.8-39.7,22-63.7,22c-4.1,0-8.2-0.2-12.2-0.7 C97.7,293.1,124.7,301.6,153.6,301.6"></path></g></svg>'},9962:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Option=void 0;const i=s(1267),r=s(2217),n=s(8907),a=s(3104),o=s(1522),h=s(6232),l=s(8989),c=s(5285);e.Option=class{};class u{constructor(t,e,s){if(this.wndMgr=t,this.option=e,this.destroying=!1,this.isPaused=!1,this.stream=new r.AppEvent.Stream,s)return;this.nes=i.default.create(),window.app=this,this.nes.setVblankCallback((t=>this.onVblank(t))),this.nes.setBreakPointCallback((()=>this.onBreakPoint())),this.subscription=this.stream.subscribe(((t,e)=>this.handleAppEvent(t,e)));const n=new h.default(this.wndMgr,this,this.nes,this.stream);this.screenWnd=n,this.title=e.title||"NES",this.screenWnd.setTitle(this.title);const a=this.screenWnd.getWindowSize(),o=c.default.clamp((e.centerX||0)-a.width/2,0,window.innerWidth-a.width-1),l=c.default.clamp((e.centerY||0)-a.height/2,0,window.innerHeight-a.height-1);this.screenWnd.setPos(o,l)}static create(t,e){return new u(t,e)}loadRom(t){const e=this.nes.setRomData(t);return!0!==e?e:(this.setupAudioManager(),this.nes.reset(),this.nes.getCpu().pause(!1),this.screenWnd.getContentHolder().focus(),!0)}bootDiskBios(t){return this.fds=new o.default(t,this.nes),this.setupAudioManager(),this.nes.reset(),this.nes.getCpu().pause(!1),this.screenWnd.getContentHolder().focus(),!0}setDiskImage(t){if(null==this.fds)return!1;const e=this.fds.setImage(t);return e&&(this.screenWnd.createFdsCtrlWnd(this.fds),this.wndMgr.moveToTop(this.screenWnd)),e}close(){this.screenWnd.close()}saveData(){const t=this.nes.save();return l.default.putObject(this.title,t)}saveDataAs(){const t=this.nes.save(),e=new Blob([JSON.stringify(t)],{type:"application/json"}),s=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.href=s,i.download=`${this.title}.sav`,i.click(),document.body.removeChild(i)}hasSaveData(){return l.default.hasKey(this.title)}loadData(){const t=l.default.getObject(this.title,null);if(t)try{this.nes.load(t)}catch(t){console.error(t),this.wndMgr.showSnackbar("Error: Load data failed")}else this.wndMgr.showSnackbar(`No save data for "${this.title}"`)}loadDataFromFile(){const t=document.createElement("input");t.type="file",t.accept=".sav, application/json",t.onchange=e=>{if(!t.value)return;const s=t.files;if(s){const t=s[0];a.default.loadFile(t).then((t=>this.loadDataFromBinary(t)))}t.value=""},t.click()}loadDataFromBinary(t){try{const e=(new TextDecoder).decode(t),s=JSON.parse(e);this.nes.load(s)}catch(t){console.error(t),this.wndMgr.showSnackbar("Error: Load data failed")}}setupAudioManager(){null==this.audioManager?this.audioManager=new n.default:this.audioManager.releaseAllChannels();const t=this.nes.getSoundChannelTypes();for(const e of t)this.audioManager.addChannel(e)}isTop(){return this.screenWnd.isTop()}destroy(){this.cleanUp(),this.option.onClosed&&this.option.onClosed(this)}cleanUp(){this.destroying=!0,this.audioManager&&this.audioManager.release(),this.subscription.unsubscribe()}handleAppEvent(t,e){switch(t){case 1:if(!this.isPaused){const t=e;this.update(t)}break;case 3:this.nes.getCpu().pause(!1);break;case 4:this.nes.getCpu().pause(!0),this.muteAudio();break;case 5:this.nes.step(0);break;case 6:this.nes.reset();break;case 10:this.isPaused=!0,this.muteAudio();break;case 11:this.isPaused=!1;break;case 12:e===this.screenWnd&&this.destroy()}}onVblank(t){t<1&&this.render(),this.updateAudio()}onBreakPoint(){this.stream.triggerBreakPoint()}update(t){if(this.nes.getCpu().isPaused())return;for(let t=0;t<2;++t){const e=this.screenWnd.getPadStatus(t);this.nes.setPadStatus(t,e)}const e=Math.min(t,66.66666666666667)*this.screenWnd.getTimeScale();this.nes.runMilliseconds(e)}render(){this.stream.triggerRender()}updateAudio(){const t=this.audioManager;if(null==t)return;const e=t.getChannelCount();for(let s=0;s<e;++s){const e=this.nes.getSoundVolume(s);t.setChannelVolume(s,e),e>0&&(t.setChannelFrequency(s,this.nes.getSoundFrequency(s)),t.setChannelDutyRatio(s,this.nes.getSoundDutyRatio(s)))}}muteAudio(){const t=this.audioManager.getChannelCount();for(let e=0;e<t;++e)this.audioManager.setChannelVolume(e,0)}}e.default=u},2217:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AppEvent=void 0;const i=s(3576);!function(t){class e extends i.Subject{triggerUpdate(t){this.next(1,t)}triggerRender(){this.next(2)}triggerRun(){this.next(3)}triggerPause(){this.next(4)}triggerStep(){this.next(5)}triggerReset(){this.next(6)}triggerBreakPoint(){this.next(7)}triggerStartCalc(){this.next(8)}triggerEndCalc(){this.next(9)}triggerPauseApp(){this.next(10)}triggerResumeApp(){this.next(11)}triggerCloseWnd(t){this.next(12,t)}}t.Stream=e}(e.AppEvent||(e.AppEvent={}))},7452:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ControlWnd=e.TraceWnd=e.RegisterWnd=void 0;const i=s(748),r=s(3104),n=s(4192),a=s(4558),o=s(5285);class h extends i.default{constructor(t,e,s){super(t,100,160,"Regs"),this.nes=e,this.stream=s,this.valueElems=new Array;const i=this.createContent();this.setContent(i),this.subscription=this.stream.subscribe((t=>{switch(t){case 6:case 5:case 4:case 7:this.updateStatus()}})),t.add(this)}static createPregStr(t){const e=new Array(8);for(let s=0;s<8;++s)e[s]=0!=(t&128>>s)?"NV_BDIZC"[s]:".";return e.join("")}updateStatus(){const t=this.nes.getCpu().getRegs();this.valueElems[0].value=o.default.hex(t.pc,4),this.valueElems[1].value=o.default.hex(t.a,2),this.valueElems[2].value=o.default.hex(t.x,2),this.valueElems[3].value=o.default.hex(t.y,2),this.valueElems[4].value=o.default.hex(t.s,2),this.valueElems[5].value=h.createPregStr(t.p),this.valueElems[6].value=String(this.nes.getCycleCount())}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}createContent(){const t=document.createElement("div");t.className="fixed-font";const e=[{name:"PC"},{name:"A"},{name:"X"},{name:"Y"},{name:"S"},{name:"P"},{name:"cycle"}],s=document.createElement("table");r.default.setStyles(s,{fontSize:"10px",width:"100%"}),this.valueElems=[];for(let t=0;t<e.length;++t){const i=document.createElement("tr");s.appendChild(i);const r=document.createElement("td");r.innerText=e[t].name,i.appendChild(r);const n=document.createElement("td");i.appendChild(n);const a=document.createElement("input");a.className="fixed-font",a.type="text",a.style.width="100%",n.appendChild(a),this.valueElems.push(a)}return t.appendChild(s),t}}e.RegisterWnd=h;const l={opType:0,addressing:0,bytes:1,cycle:0};class c extends i.default{constructor(t,e,s){super(t,400,160,"Trace"),this.nes=e,this.stream=s,this.mem=new Uint8Array(3),this.bins=new Array(3),this.lines=new Array;const i=this.createContent();this.setContent(i),this.reset(),this.subscription=this.stream.subscribe((t=>{switch(t){case 6:this.reset();case 5:case 4:case 7:this.updateStatus()}})),t.add(this)}reset(){this.lines=[]}updateStatus(){const t=this.nes.getCpu(),e=this.nes.getBus(),s=t.getRegs().pc,i=e.read8(s),r=n.kInstTable[i]||l;for(let t=0;t<r.bytes;++t){const i=e.read8(s+t);this.mem[t]=i,this.bins[t]=o.default.hex(i,2)}for(let t=r.bytes;t<3;++t)this.bins[t]="  ";const h=o.default.hex(s,4),c=this.bins.join(" "),u=a.default(r,this.mem,1,s);this.putConsole(`${h}: ${c}   ${u}`)}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}createContent(){const t=document.createElement("div"),e=document.createElement("textarea");return e.className="fixed-font",r.default.setStyles(e,{fontSize:"14px",width:"100%",height:"160px",resize:"none",margin:"0",padding:"2px",border:"none",boxSizing:"border-box"}),t.appendChild(e),this.textarea=e,t}putConsole(t){this.lines.push(t),this.lines.length>100&&this.lines.shift(),this.textarea.value=this.lines.join("\n"),this.textarea.scrollTop=this.textarea.scrollHeight}}e.TraceWnd=c;class u extends i.default{constructor(t,e){super(t,192,32,"Control"),this.stream=e;const s=this.createElement();this.setContent(s),this.updateState(!0),this.subscription=this.stream.subscribe((t=>{switch(t){case 3:this.updateState(!1);break;case 4:case 7:this.updateState(!0)}})),t.add(this)}updateState(t){this.stepBtn.disabled=!t,this.runBtn.disabled=!t,this.pauseBtn.disabled=t}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}createElement(){const t=document.createElement("div");r.default.setStyles(t,{width:"256px",height:"32px"}),this.stepBtn=document.createElement("button"),this.stepBtn.innerText="Step",this.stepBtn.addEventListener("click",(()=>{this.stream.triggerStep()})),t.appendChild(this.stepBtn),this.runBtn=document.createElement("button"),this.runBtn.innerText="Run",this.runBtn.addEventListener("click",(()=>{this.stream.triggerRun()})),t.appendChild(this.runBtn),this.pauseBtn=document.createElement("button"),this.pauseBtn.innerText="Pause",this.pauseBtn.addEventListener("click",(()=>{this.stream.triggerPause()})),t.appendChild(this.pauseBtn);const e=document.createElement("button");return e.innerText="Reset",e.addEventListener("click",(()=>{this.stream.triggerReset()})),t.appendChild(e),t}}e.ControlWnd=u},3973:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FdsCtrlWnd=void 0;const i=s(3104),r=s(748);class n extends r.default{constructor(t,e){super(t,80,30,"FDS Ctrl"),this.fds=e,this.sideCount=0,this.select=this.createUi(),this.checkSideCount()||this.select.addEventListener("click",(()=>{this.checkSideCount()})),t.add(this)}checkSideCount(){if(0!==this.sideCount)return!1;const t=this.fds.getSideCount();return!(t<=0||(this.sideCount=t,this.createOptions(this.select,t),0))}createUi(){const t=document.createElement("div");t.className="full-size",i.default.setStyles(t,{display:"flex",alignItems:"center"});const e=document.createElement("select");return i.default.setStyles(e,{margin:"auto"}),t.appendChild(e),this.setContent(t),e}createOptions(t,e){const s=["A","B"];for(let i=0;i<e;++i){const e=document.createElement("option");e.innerText=`${1+(i/2|0)}-${s[1&i]}`,t.appendChild(e)}t.addEventListener("change",(e=>{this.fds.eject(),setTimeout((()=>{this.fds.setSide(t.selectedIndex)}),100)}))}}e.FdsCtrlWnd=n},1097:(__unused_webpack_module,exports,__webpack_require__)=>{"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const app_1=__webpack_require__(9962),audio_manager_1=__webpack_require__(8907),dom_util_1=__webpack_require__(3104),nes_1=__webpack_require__(1267),screen_wnd_1=__webpack_require__(6232),util_1=__webpack_require__(5285),WIDTH=256,HEIGHT=240,MAX_FRAME_COUNT=4;class JsNes extends nes_1.default{constructor(){super(),this.reset()}setFile(t){return null==t?Promise.reject("null"):(this.file=t,this.setMemoryMap(),this.mapper=this.createMapper(0,-1),this.reload())}reload(){return dom_util_1.default.loadFile(this.file).then((data=>{const jsCode=new TextDecoder("utf-8").decode(data);return this.jsCpu=eval(jsCode),this.ppu.setChrData(this.jsCpu.getChrRom()),this.jsCpu.init(this.bus,this.ppu),Promise.resolve()}))}reset(){this.ram.fill(255),this.ppu.reset(),this.apu.reset(),null!=this.jsCpu&&this.jsCpu.reset()}update(){null!=this.jsCpu&&this.jsCpu.update()}step(t){return this.jsCpu.step(),1}}class JsScreenWnd extends screen_wnd_1.default{constructor(t,e,s,i){super(t,e,s,i),this.jsApp=e,this.jsNes=s,this.canvas=JsScreenWnd.createCanvas(WIDTH,HEIGHT),this.context=dom_util_1.default.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.canvas.className="pixelated full-size",this.setContent(this.canvas)}static createCanvas(t,e){const s=document.createElement("canvas");return s.width=t,s.height=e,s.className="full-size",dom_util_1.default.setStyles(s,{display:"block"}),dom_util_1.default.clearCanvas(s),s}render(){this.jsNes.render(this.imageData.data),this.context.putImageData(this.imageData,0,0)}setUpMenuBar(){this.addMenuBar([{label:"File",submenu:[{label:"Pause",click:()=>{this.jsNes.jsCpu.isPaused()?this.stream.triggerRun():this.stream.triggerPause()}},{label:"Reset",click:()=>{this.stream.triggerReset()}},{label:"Reload",click:()=>{this.jsApp.reload()}},{label:"Quit",click:()=>{this.close()}}]},{label:"Debug",submenu:[{label:"Palette",click:()=>{this.createPaletWnd()}},{label:"NameTable",click:()=>{this.createNameTableWnd()}},{label:"PatternTable",click:()=>{this.createPatternTableWnd()}},{label:"Control",click:()=>{this.createControlWnd()}}]}])}}class JsApp extends app_1.default{constructor(t,e){super(t,e,!0),this.leftTime=0,this.jsNes=new JsNes,this.jsScreenWnd=new JsScreenWnd(this.wndMgr,this,this.jsNes,this.stream),e.title&&this.jsScreenWnd.setTitle(e.title),this.subscription=this.stream.subscribe(((t,e)=>this.handleAppEvent(t,e))),this.nes=this.jsNes,this.screenWnd=this.jsScreenWnd;const s=this.screenWnd.getWindowSize(),i=util_1.default.clamp((e.centerX||0)-s.width/2,0,window.innerWidth-s.width-1),r=util_1.default.clamp((e.centerY||0)-s.height/2,0,window.innerHeight-s.height-1);this.screenWnd.setPos(i,r)}setFile(t){this.jsNes.setFile(t).then((()=>{this.audioManager=new audio_manager_1.default,this.setupAudioManager()}))}reload(){this.jsNes.reload()}handleAppEvent(t,e){switch(t){case 3:this.jsNes.jsCpu.pause(!1);break;case 4:this.jsNes.jsCpu.pause(!0);break;case 5:this.jsNes.step();break;case 6:this.jsNes.reset();break;default:return super.handleAppEvent(t,e)}}update(t){for(let t=0;t<2;++t){const e=this.screenWnd.getPadStatus(t);this.nes.setPadStatus(t,e)}const e=t+this.leftTime;let s=60*e/1e3|0;if(s<=MAX_FRAME_COUNT?this.leftTime=e-(1e3*s/60|0):(s=MAX_FRAME_COUNT,this.leftTime=0),s*=this.screenWnd.getTimeScale(),s>0){const t=this.jsNes.getPpu();for(let e=0;e<s;++e)t.clearVBlank(),this.jsNes.update(),this.updateAudio(),t.setHcount(240),t.setVBlank();this.jsScreenWnd.render(),this.stream.triggerRender()}}}exports.default=JsApp},1112:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.KeyConfigWnd=e.GamepadWnd=void 0;const i=s(3104),r=s(3839),n=s(1907),a=s(8989),o=s(748),h=s(5573),l=[{x:175,y:40,padbit:0,opt:{type:"round"}},{x:130,y:40,padbit:1,opt:{type:"round"}},{x:50,y:110,padbit:2,opt:{width:60,height:20}},{x:120,y:110,padbit:3,opt:{width:60,height:20}},{x:40,y:10,padbit:4},{x:40,y:70,padbit:5},{x:10,y:40,padbit:6},{x:70,y:40,padbit:7}];class c extends o.default{constructor(t,e,s,r){super(t,230,150,e),this.onClose=r,this.selectedButton=null;const n=document.createElement("div");n.className="gamepad-content",i.default.setStyles(n,{width:"230px",height:"150px"}),this.setContent(n),n.addEventListener("click",(()=>{this.setSelectedButton(null)})),this.buttons=l.map((t=>{const e=s[t.padbit],i=c.createButton(n,t.x,t.y,e,t.opt);return i.addEventListener("click",(t=>{t.stopPropagation(),this.setSelectedButton(i)})),i})),this.selectedButton=null}static createButton(t,e,s,r,n={}){const a=document.createElement("div");return a.className="gamepad-btn",i.default.setStyles(a,{left:`${e}px`,top:`${s}px`,width:`${n.width||30}px`,height:`${n.height||30}px`,overflow:"hidden"}),a.innerHTML=r,"round"===n.type&&(a.style.borderRadius="15px"),t.appendChild(a),a}close(){null!=this.onClose&&this.onClose(),super.close()}onEvent(t,e){switch(t){case 0:this.updateGamepad()}}updateButtonLabels(t){for(let e=0;e<this.buttons.length;++e)this.buttons[e].innerHTML=t[e]}updateGamepad(){if(null!=this.selectedButton&&this.isTop()){const t=this.buttons.indexOf(this.selectedButton);this.modifyButton(t)&&this.setSelectedButton(null)}const t=this.checkGamepad();this.updateGamepadPressed(t)}updateGamepadPressed(t){for(let e=0;e<l.length;++e){const s=this.buttons[e];0==(t&1<<l[e].padbit)?s.classList.remove("pressed"):s.classList.add("pressed")}}setSelectedButton(t){null!=this.selectedButton&&this.selectedButton.classList.remove("selected"),this.selectedButton!==t?(this.selectedButton=t,null!=this.selectedButton&&this.selectedButton.classList.add("selected")):this.selectedButton=null}}const u=["A","B","Select","Start","&uarr;","&darr;","&larr;","&rarr;"];e.GamepadWnd=class extends c{constructor(t,e){super(t,"Gamepad Config",u,e),t.add(this)}checkGamepad(){return!this.getGamepad(0)||this.wndMgr.isBlur()?0:r.default.getState(0)}modifyButton(t){const e=this.getGamepad(0);if(!e)return!1;for(let s=0;s<e.buttons.length;++s)if(e.buttons[s].pressed)return r.default.setButton(l[t].padbit,s),!0;const s=r.default.AXIS_THRESHOLD;for(let i=0;i<e.axes.length;++i){const n=e.axes[i];if(n<-s)return r.default.setAxis(l[t].padbit,i,-1),!0;if(n>s)return r.default.setAxis(l[t].padbit,i,1),!0}return!1}getGamepad(t){if(!window.Gamepad)return null;const e=navigator.getGamepads();return t>=e.length?null:e[t]}};const d=(()=>{const t={ArrowUp:"&uarr;",ArrowDown:"&darr;",ArrowLeft:"&larr;",ArrowRight:"&rarr;",Period:".",Comma:",",Slash:"/",Semicolon:";",Quote:"'",BracketLeft:"[",BracketRight:"]",Backslash:"\\",Minus:"-",Equal:"=",Backquote:"`",ControlLeft:"CtrlL",ControlRight:"CtrlR",ShiftLeft:"ShiftL",ShiftRight:"ShiftR",AltLeft:"AltL",AltRight:"AltR",MetaLeft:"MetaL",MetaRight:"MetaR"};for(let e="A".charCodeAt(0);e<="Z".charCodeAt(0);++e){const s=String.fromCharCode(e);t[`Key${s}`]=s}for(let e=0;e<=9;++e)t[`Digit${e}`]=e.toString();return t})();class p extends c{static loadSetting(){const t=a.default.getObject("keymap",null);if(Array.isArray(t))for(let e=0;e<2&&!(e>=t.length)&&Array.isArray(t[e]);++e){const s=n.default.getMapping(e);for(let i=0;i<t[e].length;++i){const r=s.findIndex((t=>t.bit===1<<i));r>=0&&(s[r].key=t[e][i])}}}static saveSetting(){const t=new Array(2);for(let e=0;e<2;++e){const s=n.default.getMapping(e),i=[...Array(8).keys()].map((t=>{const e=s.findIndex((e=>e.bit===1<<t));return e>=0?s[e].key:null}));t[e]=i}a.default.putObject("keymap",t)}constructor(t,e){super(t,"Key Config",u,e),this.updateLabels(),t.add(this)}checkGamepad(){const t=this.wndMgr.getKeyboardManager(),e=n.default.getMapping(0);let s=0;for(let i=0;i<e.length;++i)t.getKeyPressing(e[i].key)&&(s|=e[i].bit);return s}modifyButton(t){const e=this.wndMgr.getKeyboardManager().getLastPressing();if(!e)return!1;const s=l[t],i=n.default.getMapping(0);for(let t=0;t<i.length;++t){const t=i.findIndex((t=>t.bit===1<<s.padbit));if(t>=0)return i[t].key=e,this.updateLabels(),p.saveSetting(),!0}return!1}updateLabels(){const t=n.default.getMapping(0).map((t=>t.key in d?d[t.key]:h(t.key)));super.updateButtonLabels(t)}}e.KeyConfigWnd=p},1990:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AboutWnd=e.VolumeWnd=e.EqualizerWnd=e.AudioWnd=e.GlobalPaletWnd=e.PatternTableWnd=e.NameTableWnd=e.PaletWnd=e.FpsWnd=void 0;const i=s(748),r=s(8907),n=s(3104),a=s(6042),o=s(7162),h=s(8989),l=s(5285),c=s(2792),u=s(4570),d=s(6199),p=.25,g="volume";class f extends i.default{constructor(t,e){super(t,80,48,"Fps"),this.stream=e;const s=document.createElement("div");n.default.setStyles(s,{width:"80px",height:"48px"}),this.setContent(s),this.stats=new c,this.stats.domElement.style.position="",s.appendChild(this.stats.domElement),this.subscription=this.stream.subscribe((t=>{switch(t){case 8:this.stats.begin();break;case 9:this.stats.end()}})),t.add(this)}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}}e.FpsWnd=f;class m extends i.default{constructor(t,e,s){super(t,m.W*m.UNIT,m.H*m.UNIT,"Palette"),this.nes=e,this.stream=s,this.palet=new Uint8Array(m.W*m.H),this.tmp=new Uint8Array(m.W*m.H),this.selected=new Uint8Array(m.H);const{root:i,boxes:r,groups:n}=this.createDom();this.setContent(i),this.boxes=r,this.groups=n,this.selected.fill(0),this.subscription=this.stream.subscribe((t=>{switch(t){case 2:this.render()}})),this.palet.fill(-1),this.render(),t.add(this)}getSelectedPalets(t){const e=this.selected;for(let s=0;s<e.length;++s)t[s]=e[s]}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=this.tmp;this.getPalet(t);const e=m.W*m.H;for(let s=0;s<e;++s){const e=t[s];if(e===this.palet[s])continue;this.palet[s]=e;const i=o.kPaletColors[e],r=i>>16,n=i>>8&255,a=255&i;this.boxes[s].style.backgroundColor=`rgb(${r},${n},${a})`}}getPalet(t){const e=this.nes.getPpu(),s=m.W*m.H,i=e.getPaletTable();for(let e=0;e<s;++e)t[e]=63&i[e]}createDom(){const t=m.UNIT,e=m.W,s=m.H,i=document.createElement("div");i.className="clearfix",n.default.setStyles(i,{width:t*e+"px",height:t*s+"px"});const r=new Array(e*s),a=new Array(e/4*s);for(let o=0;o<s;++o){const s=document.createElement("div");s.className="pull-left clearfix",n.default.setStyles(s,{width:t*e+"px",height:`${t}px`,backgroundColor:"black"}),i.appendChild(s);for(let i=0;i<e/4;++i){const h=document.createElement("div");h.className="pull-left clearfix",n.default.setStyles(h,{width:4*t+"px",height:`${t}px`,cursor:"pointer"}),a[i+o*(e/4)]=h,s.appendChild(h),h.addEventListener("click",(t=>{this.select(o,i)}));for(let s=0;s<4;++s){const a=document.createElement("div");a.className="pull-left",n.default.setStyles(a,{width:t-1+"px",height:t-1+"px",marginRight:"1px"}),r[4*i+s+o*e]=a,h.appendChild(a)}}}return{root:i,boxes:r,groups:a}}select(t,e){this.groups[t*(m.W/4)+this.selected[t]].style.backgroundColor="",this.groups[t*(m.W/4)+e].style.backgroundColor="red",this.selected[t]=e}}e.PaletWnd=m,m.UNIT=8,m.W=16,m.H=2;class b extends i.default{constructor(t,e,s,i){const r=256*(i?1:2),a=240*(i?2:1);super(t,r,a,"NameTable"),this.ppu=e,this.stream=s,this.vert=i;const o=document.createElement("canvas");o.width=r,o.height=a,n.default.setStyles(o,{width:`${r}px`,height:`${a}px`}),o.className="pixelated",n.default.clearCanvas(o),this.setContent(o),this.canvas=o,this.context=n.default.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.subscription=this.stream.subscribe((t=>{switch(t){case 2:this.render()}})),this.render(),t.add(this)}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=this.vert?0:256,e=this.vert?240:0;a.default.renderNameTable1(this.ppu,this.imageData.data,this.imageData.width,0,0,0),a.default.renderNameTable1(this.ppu,this.imageData.data,this.imageData.width,t,e,1),this.context.putImageData(this.imageData,0,0)}}e.NameTableWnd=b;class k extends i.default{constructor(t,e,s,i){super(t,256,128,"PatternTable"),this.ppu=e,this.stream=s,this.getSelectedPalets=i,this.buf=new Uint8Array(2);const r=k.createCanvas();this.setContent(r),this.canvas=r,this.context=n.default.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.subscription=this.stream.subscribe((t=>{switch(t){case 2:this.render()}})),this.render(),t.add(this)}static createCanvas(){const t=document.createElement("canvas");return t.width=256,t.height=128,n.default.setStyles(t,{width:"256px",height:"128px"}),t.className="pixelated",n.default.clearCanvas(t),t}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=this.buf;this.getSelectedPalets(t),a.default.renderPatternTable(this.ppu,this.imageData.data,this.imageData.width,t),this.context.putImageData(this.imageData,0,0)}}e.PatternTableWnd=k;class y extends i.default{constructor(t,e){super(t,y.W*y.UNIT,y.H*y.UNIT,"Global palette"),this.onClose=e;const{root:s,boxes:i}=this.createDom();this.setContent(s),this.boxes=i;const r=this.boxes.length;for(let t=0;t<r;++t){const e=o.kPaletColors[t],s=e>>16,i=e>>8&255,r=255&e;this.boxes[t].style.backgroundColor=`rgb(${s},${i},${r})`}t.add(this)}close(){null!=this.onClose&&this.onClose(),super.close()}createDom(){const t=y.UNIT,e=y.W,s=y.H,i=document.createElement("div");i.className="clearfix",n.default.setStyles(i,{width:t*e+"px",height:t*s+"px"});const r=new Array(e*s);for(let a=0;a<s;++a){const s=document.createElement("div");s.className="pull-left clearfix",n.default.setStyles(s,{width:t*e+"px",height:`${t}px`,backgroundColor:"black"}),i.appendChild(s);for(let i=0;i<e;++i){const o=document.createElement("div");o.className="pull-left",n.default.setStyles(o,{width:t-1+"px",height:t-1+"px",marginRight:"1px"}),r[i+a*e]=o,s.appendChild(o)}}return{root:i,boxes:r}}}e.GlobalPaletWnd=y,y.UNIT=12,y.W=16,y.H=4;const C=[0,.5,1,2,2.5,3,3.5,4,5,5.5,6,6.5];class w extends i.default{constructor(t,e,s){const i=e.getSoundChannelTypes(),r=[...Array(i.length).keys()].filter((t=>4!==i[t])),n=r.length;super(t,w.W*w.OCTAVE*7,w.H*n,"Audio"),this.nes=e,this.stream=s,this.channelIndices=r;const{root:a,dots:o}=this.createDom(n);this.setContent(a),this.dots=o,this.subscription=this.stream.subscribe((t=>{switch(t){case 2:this.render()}})),this.render(),t.add(this)}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=w.W*w.OCTAVE*7|0,e=w.H,s=12/Math.log(2),i=t/(7*w.OCTAVE),r=3*e/4|0,a=1*e/4|0;for(let t=0;t<this.channelIndices.length;++t){const o=this.channelIndices[t],h=this.dots[t],l=this.nes.getSoundVolume(o),c=this.nes.getSoundFrequency(o),u=Math.log(c)*s-w.kBaseTone+.5;if(u>=-1&&u<=12*w.OCTAVE||l<=0){const s=C[(0|u)%12],o=(s+7*(u/12|0)+u%1)*i,c=t*e+((0|s)===s?r:a);n.default.setStyles(h,{left:o-3.5+"px",top:c-3.5+"px",opacity:`${Math.pow(l,1/4)}`})}else n.default.setStyles(h,{opacity:"0"})}}createDom(t){const e=w.W,s=w.H,i=document.createElement("div"),r=e*w.OCTAVE*7,a=s*t;i.className="clearfix",n.default.setStyles(i,{width:`${r}px`,height:`${a}px`,position:"relative",overflow:"hidden"});const o=[0,2,3,5,6];for(let r=0;r<t;++r){const t=document.createElement("div");t.className="pull-left clearfix",n.default.setStyles(t,{width:"100%",height:`${s}px`,backgroundColor:"white",overflow:"hidden",position:"relative"}),i.appendChild(t);for(let i=0;i<7*w.OCTAVE;++i){const i=document.createElement("div");i.className="pull-left",n.default.setStyles(i,{width:e-1+"px",height:s-1+"px",backgroundColor:"white",borderLeft:"black solid 1px",borderBottom:"black solid 1px"}),t.appendChild(i)}for(let i=-1;i<w.OCTAVE;++i)for(let r=i>=0?0:o.length-1;r<o.length;++r){const a=7*i+o[r],h=document.createElement("div");n.default.setStyles(h,{position:"absolute",left:a*e+e/2+1+"px",top:"0",width:e-2+"px",height:s/2+"px",backgroundColor:"black"}),t.appendChild(h)}}const h=new Array(t);for(let e=0;e<t;++e){const t=document.createElement("div");n.default.setStyles(t,{position:"absolute",left:"0",top:"0",width:"7px",height:"7px",backgroundColor:"red",borderRadius:"7px"}),i.appendChild(t),h[e]=t}return{root:i,dots:h}}}e.AudioWnd=w,w.W=8,w.H=32,w.OCTAVE=5,w.kBaseToneFreq=440/Math.pow(2,3),w.kBaseTone=12*Math.log(w.kBaseToneFreq)/Math.log(2);class v extends i.default{constructor(t,e){super(t,256,128,"Equalizer"),this.onClose=e,this.mode=0;const s=document.createElement("canvas");if(s.width=256,s.height=128,n.default.setStyles(s,{width:"256px",height:"128px"}),s.className="pixelated",n.default.clearCanvas(s),this.setContent(s),this.canvas=s,this.context=n.default.getCanvasContext2d(this.canvas),this.canvas.addEventListener("click",(()=>{this.mode=1-this.mode})),!this.setUp()){const t=document.createElement("div");t.innerText="No audio",n.default.setStyles(t,{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",color:"red"}),this.getContentHolder().appendChild(t)}t.add(this)}close(){this.onClose(),super.close()}onEvent(t,e){switch(t){case 0:this.render()}}setUp(){if(null!=this.analyserNode)return!1;const t=r.default.createAnalyser();if(null==t)return!1;this.analyserNode=t,this.analyserNode.fftSize=256;const e=this.analyserNode.frequencyBinCount;return this.dataArray=new Uint8Array(e),!0}render(){if(null!=this.dataArray)switch(this.mode){case 0:this.renderFrequency();break;case 1:this.renderTimeDomain()}}renderFrequency(){const t=this.context,e=this.dataArray,s=e.length;this.analyserNode.getByteFrequencyData(e),t.fillStyle="rgb(0, 0, 0)",t.fillRect(0,0,256,128);let i=0;t.fillStyle="rgb(0,255,64)";for(let r=0;r<64;++r){const n=128*e[r*s/64|0]/255|0;t.fillRect(i,128-n,3,n),i+=4}}renderTimeDomain(){const t=this.dataArray,e=t.length;this.analyserNode.getByteTimeDomainData(t),this.context.fillStyle="rgb(0, 0, 0)",this.context.fillRect(0,0,256,128);const s=this.context;s.strokeStyle="rgb(255,255,255)",s.beginPath();for(let i=0;i<e;++i){const r=64-(128*(t[i]-128)/128|0),n=256*i/e;0===i?s.moveTo(n,r):s.lineTo(n,r)}s.stroke()}}e.EqualizerWnd=v;class B extends i.default{constructor(t,e){super(t,32,120,"V"),this.onClose=e;const s=this.createDom();this.setContent(s)}static setUp(){B.volume=B.readVolumeFromStorage();const t=window.AudioContext||window.webkitAudioContext;r.default.setUp(t),r.default.setMasterVolume(B.volume*p)}static onFocusChanged(t){t?r.default.setMasterVolume(B.volume*p):r.default.setMasterVolume(0)}static readVolumeFromStorage(){return l.default.clamp(h.default.getFloat(g,1),0,1)}close(){this.onClose(),super.close()}createDom(){const t=document.createElement("div");t.id="volume-slider-container",t.className="volume-slider-container full-size";const e=document.createElement("div");e.className="full-size",t.appendChild(e);const s=document.createElement("div");s.id="volume-slider",s.className="volume-slider",s.style.height="100px",e.appendChild(s);let i=!1;return t.addEventListener("mousedown",(t=>{if(0!==t.button||i)return;i=!0;const e=s.parentNode.getBoundingClientRect().height,a=t=>{const[,i]=n.default.getMousePosIn(t,s.parentNode),a=l.default.clamp(e-i,0,e);s.style.height=`${a}px`,B.volume=a/e,r.default.setMasterVolume(B.volume*p)};n.default.setMouseDragListener({move:a,up:t=>{i=!1,B.volume=Math.round(100*B.volume)/100,h.default.put(g,B.volume)}}),a(t)})),s.style.height=`${Math.round(114*B.volume)}px`,t}}e.VolumeWnd=B,B.volume=0;class M extends i.default{constructor(t,e){super(t,200,128,"About"),this.onClose=e;const s=document.createElement("div");s.className="full-size",n.default.setStyles(s,{background:"white"}),s.innerHTML=`<div class="full-size" style="display:flex; align-items:center; justify-content:center;">\n  <div>\n    <div>NES Emulator</div>\n    <div>Version: 0.9.0</div>\n    <div style="height:8px"></div>\n    <div>\n      <center>\n        <a href="https://github.com/tyfkda/nesemu/" target="_blank" rel="noopener noreferrer">${u}</a\n        ><div style="display:inline-block; width:8px; height:8px"></div\n        ><a href="https://twitter.com/tyfkda/" target="_blank" rel="noopener noreferrer">${d} </a>\n      </center>\n    </div>\n  </div>\n</div>`,this.setContent(s),t.add(this),t.moveToCenter(this)}close(){this.onClose(),super.close()}}e.AboutWnd=M},6042:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(8453),r=s(9763),n=s(7162);function a(t,e,s,i,r,a,o){for(let h=0;h<8;++h){const l=s[h];for(let s=0;s<8;++s){let c=a;const u=l>>14-(s<<1)&3;if(0!==u){const t=63&r[i|u];c=n.kPaletColors[t]}const d=4*(h*o+s+e);t[d+0]=c>>16,t[d+1]=c>>8&255,t[d+2]=255&c}}}e.default=class{static renderNameTable1(t,e,s,o,h,l){const c=t.getRegs(),u=t.getVram(),d=t.getPaletTable(),p=t.getChrData(),g=t.getHStatusMgr(),f=g.current.mirrorModeBit,m=g.current.chrBankOffset,b=l<<10,k=i.getBgPatternTableAddress(c[0]),y=n.kPaletColors[63&d[0]],C=new Uint16Array(8);for(let t=0;t<r.Const.HEIGHT/8;++t){const n=t%30;for(let l=0;l<r.Const.WIDTH/8;++l){const r=31&l,c=i.getNameTable(0,l,t,f)+b,g=16*u[c+r+(n<<5)]+k,w=(2&r)+((2&n)<<1),v=(u[c+960+((r>>2)+(n<<1&248))]>>w&3)<<2;for(let t=0;t<8;++t)C[t]=i.getBgPat(p,g,t,m);a(e,(8*t+h)*s+8*l+o,C,v,d,y,s)}}}static renderPatternTable(t,e,s,r){const o=t.getRegs(),h=t.getPaletTable(),l=t.getChrData(),c=t.getHStatusMgr().current.chrBankOffset,u=0==(8&o[0])?1:0,d=new Uint16Array(8);for(let t=0;t<2;++t){const o=t^u,p=r[o]<<2|o<<4|0,g=n.kPaletColors[63&h[p]],f=128*t;for(let r=0;r<16;++r)for(let n=0;n<16;++n){const o=16*(n+16*r+256*t);for(let t=0;t<8;++t)d[t]=i.getBgPat(l,o,t,c);a(e,8*r*s+8*n+f,d,p,h,g,s)}}}}},6232:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(748),r=s(3104),n=s(1357),a=s(8907),o=s(1907),h=s(3839),l=s(7452),c=s(1990),u=s(3973),d=256,p=240,g="0.1s";let f=!1;function m(t,e,s){return t/e>=s?t=e*s:e=t/s,[t,e]}class b extends i.default{constructor(t,e,s,n){if(super(t,512,448+i.default.MENUBAR_HEIGHT,"NES"),this.app=e,this.nes=s,this.stream=n,this.hideEdge=!0,this.contentWidth=0,this.contentHeight=0,this.scalerType=0,this.padKeyHandler=new o.default,this.timeScale=1,this.wndMap=new Array,null!=e&&null!=s&&null!=n){if(this.setUpMenuBar(),this.contentHolder.style.overflow="hidden",this.fullscreenBase=document.createElement("div"),this.fullscreenBase.className="full-size",r.default.setStyles(this.fullscreenBase,{position:"relative",overflow:"hidden"}),this.setContent(this.fullscreenBase),this.canvasHolder=document.createElement("div"),this.canvasHolder.style.transitionDuration=g,this.fullscreenBase.appendChild(this.canvasHolder),this.setScaler(0),this.addResizeBox(),this.subscription=this.stream.subscribe((t=>{switch(t){case 2:this.render();break;case 6:this.scaler.reset()}})),this.contentWidth=512,this.contentHeight=448,this.updateContentSize(this.contentWidth,this.contentHeight),!f){const t=document.createElement("button");t.innerText="Enable audio",r.default.setStyles(t,{position:"absolute",right:0,top:0}),t.addEventListener("click",(e=>{a.default.enableAudio(),this.app.setupAudioManager(),t.parentNode.removeChild(t),f=!0,this.wndMgr.setFocus()})),this.fullscreenBase.appendChild(t)}this.fullscreenResizeFunc=()=>{const t=document.body.getBoundingClientRect();let e=t.width,s=t.height;e/s>=d/p?e=s*(d/p)|0:s=.9375*e|0,r.default.setStyles(this.fullscreenBase,{width:`${e}px`,height:`${s}px`,margin:"auto"}),this.updateContentSize(e,s)},t.add(this),window.$DEBUG&&(this.createPaletWnd(),this.createNameTableWnd(),this.createPatternTableWnd(),this.createTraceWnd(),this.createRegisterWnd(),this.createControlWnd())}}getTimeScale(){return this.timeScale}onEvent(t,e){switch(t){case 2:this.stream.triggerPauseApp();break;case 4:this.stream.triggerResumeApp();break;case 7:this.canvasHolder.style.transitionDuration="0s",this.stream.triggerPauseApp();break;case 9:this.canvasHolder.style.transitionDuration=g,this.stream.triggerResumeApp();break;case 8:{const{width:t,height:s}=e;this.onResized(t,s)}break;case 5:this.stream.triggerPauseApp();break;case 6:this.stream.triggerResumeApp();break;case 0:{this.padKeyHandler.update(this.wndMgr.getKeyboardManager());const t=this.isTop()&&this.wndMgr.getKeyboardManager().getKeyPressing("ShiftLeft");this.timeScale=t?4:1;const s=e;this.stream.triggerStartCalc(),this.stream.triggerUpdate(s),this.stream.triggerEndCalc()}break;case 10:e||(this.timeScale=1,this.padKeyHandler.clearAll())}}onResized(t,e){this.contentWidth=t,this.contentHeight=e,this.updateContentSize(t,e-i.default.MENUBAR_HEIGHT)}setClientSize(t,e){return t=Math.round(t),e=Math.round(e),super.setClientSize(t,e),this.contentWidth=t,this.contentHeight=e,this.updateContentSize(t,e),this}capture(){return this.scaler.getCanvas().toDataURL()}getPadStatus(t){return!this.isTop()||this.wndMgr.isBlur()?0:this.padKeyHandler.getStatus(t)|h.default.getState(t)}setFullscreen(t){return window.addEventListener("resize",this.fullscreenResizeFunc),this.wndMgr.setFullscreen(this.contentHolder,(e=>{e?r.default.setStyles(this.contentHolder,{backgroundColor:"black",display:"flex"}):(window.removeEventListener("resize",this.fullscreenResizeFunc),r.default.setStyles(this.fullscreenBase,{width:"",height:"",margin:""}),r.default.setStyles(this.contentHolder,{backgroundColor:"",display:""}),this.updateContentSize(this.contentWidth,this.contentHeight)),t&&t(e),this.contentHolder.focus()}))}close(){this.closeChildrenWindows(),null!=this.subscription&&this.subscription.unsubscribe(),this.stream.triggerCloseWnd(this),super.close()}render(){this.scaler.render(this.nes)}createFdsCtrlWnd(t){if(null!=this.wndMap[9])return!1;const e=new u.FdsCtrlWnd(this.wndMgr,t);return this.wndMap[9]=e,!0}closeChildrenWindows(){for(const t of Object.values(this.wndMap))null!=t&&t.close()}setClientScale(t){const e=(d-(this.hideEdge,0))*t|0,s=(p-(this.hideEdge?16:0))*t|0;return this.setClientSize(e,s)}updateContentSize(t,e){if(!this.fullscreenBase)return;const s=this.hideEdge?1*t|0:t,i=this.hideEdge?e*(p/224)|0:e,n=this.hideEdge?-0*s/d|0:0,a=this.hideEdge?-8*i/p|0:0;r.default.setStyles(this.canvasHolder,{position:"absolute",width:`${s}px`,height:`${i}px`,top:`${a}px`,left:`${n}px`})}setUpMenuBar(){this.menuItems=[{label:"File",submenu:[{label:"Pause",checked:()=>this.nes.getCpu().isPaused(),click:()=>{this.nes.getCpu().isPaused()?this.stream.triggerRun():this.stream.triggerPause()}},{label:"Reset",click:()=>{this.stream.triggerReset(),this.stream.triggerRun()}},{label:"Screenshot",click:()=>{!function(t,e){const s=document.createElement("img"),r=String(Date.now());s.src=e.capture(),s.className="pixelated full-size",s.title=s.alt=r;const n=new i.default(t,d,p,r);n.setContent(s),n.addResizeBox(),t.add(n)}(this.wndMgr,this)}},{label:"----"},{label:"Save status",click:()=>this.app.saveData()},{label:"Download status to file",click:()=>this.app.saveDataAs()},{label:"----"},{label:"Load status",disabled:()=>!this.app.hasSaveData(),click:()=>this.app.loadData()},{label:"Restore status from file",click:()=>this.app.loadDataFromFile()},{label:"----"},{label:"Quit",click:()=>{this.close()}}]},{label:"View",submenu:[{label:"1x1",checked:()=>this.isAspectRatio(1),click:()=>{this.setClientScale(1)}},{label:"2x2",checked:()=>this.isAspectRatio(2),click:()=>{this.setClientScale(2)}},{label:"Adjust aspect ratio",disabled:()=>this.isAspectRatio(0),click:()=>{this.adjustAspectRatio()}},{label:"----"},{label:"Fullscreen",click:()=>{this.setFullscreen()}}]},{label:"Scaler",submenu:[{label:"Nearest",checked:()=>0===this.scalerType,click:()=>{this.setScaler(0)}},{label:"Scanline",checked:()=>1===this.scalerType,click:()=>{this.setScaler(1)}},{label:"Epx",checked:()=>2===this.scalerType,click:()=>{this.setScaler(2)}}]},{label:"Debug",submenu:[{label:"Edge",checked:()=>!this.hideEdge,click:()=>{this.toggleEdge()}},{label:"Sprite flicker",checked:()=>!this.nes.getPpu().suppressSpriteFlicker,click:()=>{this.toggleSpriteFlicker()}},{label:"----"},{label:"Palette",click:()=>{this.createPaletWnd()}},{label:"NameTable",click:()=>{this.createNameTableWnd()}},{label:"PatternTable",click:()=>{this.createPatternTableWnd()}},{label:"Audio",click:()=>{this.createAudioWnd()}},{label:"FPS",click:()=>{this.createFpsWnd()}},{label:"----"},{label:"Trace",click:()=>{this.createTraceWnd()}},{label:"Registers",click:()=>{this.createRegisterWnd()}},{label:"Control",click:()=>{this.createControlWnd()}}]}],this.addMenuBar(this.menuItems)}maximize(){const t=this.wndMgr.getRootClientRect(),e=t.width,s=t.height,r=e-2,n=s-i.default.TITLEBAR_HEIGHT-i.default.MENUBAR_HEIGHT-2,a=Math.round(d-(this.hideEdge,0)),o=Math.round(p-(this.hideEdge?16:0)),[h,l]=m(r,n,a/o),c=(e-(h+2))/2,u=(s-(l+i.default.TITLEBAR_HEIGHT+i.default.MENUBAR_HEIGHT+2))/2;this.setPos(Math.round(c),Math.round(u)),this.setClientSize(h,l)}createPaletWnd(){if(null!=this.wndMap[1])return!1;const t=new c.PaletWnd(this.wndMgr,this.nes,this.stream);return t.setPos(520,0),this.wndMap[1]=t,!0}createNameTableWnd(){if(null!=this.wndMap[2])return!1;const t=this.nes.getPpu(),e=new c.NameTableWnd(this.wndMgr,t,this.stream,0===t.getMirrorMode());return e.setPos(520,40),this.wndMap[2]=e,!0}createPatternTableWnd(){if(null!=this.wndMap[3])return!1;const t=new c.PatternTableWnd(this.wndMgr,this.nes.getPpu(),this.stream,(t=>{const e=this.wndMap[1];return null!=e&&(e.getSelectedPalets(t),!0)}));return t.setPos(520,300),this.wndMap[3]=t,!0}createAudioWnd(){if(null!=this.wndMap[4])return!1;const t=new c.AudioWnd(this.wndMgr,this.nes,this.stream);return this.wndMap[4]=t,!0}createTraceWnd(){if(null!=this.wndMap[6])return!1;const t=new l.TraceWnd(this.wndMgr,this.nes,this.stream);return t.setPos(0,500),this.wndMap[6]=t,!0}createRegisterWnd(){if(null!=this.wndMap[5])return!1;const t=new l.RegisterWnd(this.wndMgr,this.nes,this.stream);return t.setPos(410,500),this.wndMap[5]=t,!0}createControlWnd(){if(null!=this.wndMap[7])return!1;const t=new l.ControlWnd(this.wndMgr,this.stream);return t.setPos(520,500),this.wndMap[7]=t,!0}createFpsWnd(){if(null!=this.wndMap[8])return!1;const t=new c.FpsWnd(this.wndMgr,this.stream);return this.wndMap[8]=t,!0}isAspectRatio(t){const e=this.contentHolder.getBoundingClientRect(),s=d-(this.hideEdge,0),i=p-(this.hideEdge?16:0);return t>0?Math.abs(e.width-s*t)<.5&&Math.abs(e.height-i*t)<.5:Math.abs(e.width/e.height-s/i)<.005}adjustAspectRatio(){const t=this.contentHolder.getBoundingClientRect(),e=d-(this.hideEdge,0),s=p-(this.hideEdge?16:0),[i,r]=m(t.width,t.height,e/s);this.setClientSize(i,r)}toggleEdge(){this.hideEdge=!this.hideEdge,this.updateContentSize(this.contentHolder.offsetWidth,this.contentHolder.offsetHeight)}toggleSpriteFlicker(){const t=this.nes.getPpu();t.suppressSpriteFlicker=!t.suppressSpriteFlicker}setScaler(t){const e=null==this.scaler;if(this.scalerType!==t||e){switch(this.scalerType=t,t){case 0:this.scaler=new n.NearestNeighborScaler;break;case 1:this.scaler=new n.ScanlineScaler;break;case 2:this.scaler=new n.EpxScaler}r.default.removeAllChildren(this.canvasHolder),this.canvasHolder.appendChild(this.scaler.getCanvas()),e||this.render()}}}e.default=b},8519:(t,e,s)=>{"use strict";const i=s(9962),r=s(1990),n=s(3104),a=s(1097),o=s(3839),h=s(1112),l=s(8989),c=s(5285),u=s(8982),d=s(734);s(8402);const p=s(6085);window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;class g{constructor(t){this.root=t,this.apps=[],this.diskBios=null,this.uninsertedApp=null,this.keyConfigWnd=null,this.gamepadWnd=null,this.globalPaletWnd=null,this.equalizerWnd=null,this.volumeWnd=null,this.aboutWnd=null,this.wndMgr=new u.default(t),r.VolumeWnd.setUp(),this.setUpSysmenu(),this.setUpFileDrop(),this.setUpBlur()}setUpSysmenu(){this.menuItems=[{label:"👾",submenu:[{label:"Open",click:()=>{const t=document.createElement("input");t.type="file",t.accept=".nes,.sav,.zip, application/zip",t.onchange=e=>{if(!t.value)return;const s=t.files;s&&this.createAppFromFiles(s,0,0),t.value=""},t.click()}},{label:"Global palet",click:()=>this.openGlobalPaletWnd()},{label:"Key config",click:()=>this.openKeyConfigWnd()},{label:"Gamepad",click:()=>this.openGamepadWnd(),disabled:!o.default.isSupported()},{label:"Volume",click:()=>this.openVolumeWnd()},{label:"Equalizer",click:()=>this.openEqualizerWnd()},{label:"About",click:()=>this.openAboutWnd()}]}];const t=document.getElementById("sysmenu-bar");if(null==t)return;const e=[];let s,i=-1;const r=()=>{i>=0&&(e[i].classList.remove("opened"),i=-1),s=null,t.classList.remove("selected")},n=n=>{const a=this.menuItems[n];if(!("submenu"in a)||i===n)return;null!=s&&s(),i>=0&&e[i].classList.remove("opened");const o=e[n];i=n,s=this.openSubmenu(a,o,r),o.classList.add("opened"),t.classList.add("selected")};this.menuItems.forEach(((a,o)=>{const h=document.createElement("div");h.className="sysmenu-item pull-left",h.innerText=a.label,h.addEventListener("click",(t=>{t.stopPropagation(),"submenu"in a&&(i<0?n(o):(s&&s(),r()))})),t.appendChild(h),e.push(h),h.addEventListener("mouseenter",(t=>{i>=0&&i!==o&&"submenu"in a&&n(o)}))}))}openSubmenu(t,e,s){const i={left:`${d.default.getOffsetRect(this.root,e).left}px`,bottom:"0"},r={className:"sysmenu menu-subitem-holder bottom",onClose:s};return d.default.openSubmenu(t,i,this.root,r)}setUpFileDrop(){const t=document.getElementById("drop-desc");t&&(window.File&&window.FileReader&&window.FileList&&window.Blob?(t.style.opacity="0",n.default.handleFileDrop(this.root,((e,s,i)=>{this.createAppFromFiles(e,s,i),t.style.display="none"}))):t.style.display="none")}createAppFromFiles(t,e,s){for(let i=0;i<t.length;++i){const r=t[i];if("js"!==c.default.getExt(r.name).toLowerCase())continue;const n=new a.default(this.wndMgr,{title:r.name,centerX:e,centerY:s,onClosed:t=>{this.removeApp(t)}});n.setFile(r),this.apps.push(n)}const i=["nes","bin","fds","sav"],r=new Array;for(let e=0;e<t.length;++e){const s=t[e];let a=null;const o=c.default.getExt(s.name).toLowerCase();"js"===o||(a="zip"===o?n.default.loadFile(s).then((t=>(new p).loadAsync(t))).then((t=>{for(const e of Object.keys(t.files)){const s=c.default.getExt(e).toLowerCase();if(i.indexOf(s)>=0)return t.files[e].async("uint8array").then((t=>Promise.resolve({type:s,binary:t,fileName:e})))}return Promise.reject(`No .nes file included: ${s.name}`)})):i.indexOf(o)>=0?n.default.loadFile(s).then((t=>Promise.resolve({type:o,binary:t,fileName:s.name}))):Promise.reject(`Unsupported file: ${s.name}`)),a&&r.push(a)}Promise.all(r).then((t=>{const i={};if(t.forEach((t=>{i[t.type]||(i[t.type]=[]),i[t.type].push(t)})),i.bin&&(this.diskBios=i.bin[0].binary,i.fds||(this.uninsertedApp=this.bootDiskImage(this.diskBios,null,"DISK System",e,s))),i.nes&&i.nes.forEach((t=>{this.createAppFromRom(t.binary,t.fileName,e,s),e+=16,s+=16})),i.fds){const t=this.diskBios;if(null==t)return void this.wndMgr.showSnackbar(".fds needs BIOS file (.bin) for Disk System");i.fds.forEach((i=>{null!=this.uninsertedApp?(this.uninsertedApp.setDiskImage(i.binary),this.uninsertedApp=null):this.bootDiskImage(t,i.binary,i.fileName,e,s),e+=16,s+=16}))}if(i.sav){const t=i.sav[0],e=this.findActiveApp();if(null==e)throw"Load save data failed: No active app";e.loadDataFromBinary(t.binary)}})).catch((t=>{this.wndMgr.showSnackbar(t.toString())}))}findActiveApp(){for(const t of this.apps)if(t.isTop())return t;return null}createAppFromRom(t,e,s,r){const n=e.match(/^(.*?)(\s*\(.*\))?\.\w+$/),a={title:n?n[1]:e,centerX:s,centerY:r,onClosed:t=>{this.removeApp(t)}},o=new i.default(this.wndMgr,a),h=o.loadRom(t);if(!0!==h)return this.wndMgr.showSnackbar(`${e}: ${h}`),void o.close();this.apps.push(o)}bootDiskImage(t,e,s,r,n){const a=s.match(/^(.*?)\s*\(.*\)\.\w*$/),o={title:a?a[1]:s,centerX:r,centerY:n,onClosed:t=>{this.removeApp(t)}},h=i.default.create(this.wndMgr,o);return h.bootDiskBios(t),null!=e&&h.setDiskImage(e),this.apps.push(h),h}removeApp(t){const e=this.apps.indexOf(t);e>=0&&this.apps.splice(e,1)}openGlobalPaletWnd(){null==this.globalPaletWnd?this.globalPaletWnd=new r.GlobalPaletWnd(this.wndMgr,(()=>{this.globalPaletWnd=null})):this.wndMgr.moveToTop(this.globalPaletWnd)}openKeyConfigWnd(){null==this.keyConfigWnd?this.keyConfigWnd=new h.KeyConfigWnd(this.wndMgr,(()=>{this.keyConfigWnd=null})):this.wndMgr.moveToTop(this.keyConfigWnd)}openGamepadWnd(){o.default.isSupported()&&(null==this.gamepadWnd?this.gamepadWnd=new h.GamepadWnd(this.wndMgr,(()=>{this.gamepadWnd=null})):this.wndMgr.moveToTop(this.gamepadWnd))}openEqualizerWnd(){null==this.equalizerWnd?this.equalizerWnd=new r.EqualizerWnd(this.wndMgr,(()=>{this.equalizerWnd=null})):this.wndMgr.moveToTop(this.equalizerWnd)}openVolumeWnd(){null==this.volumeWnd?(this.volumeWnd=new r.VolumeWnd(this.wndMgr,(()=>{this.volumeWnd=null})),this.wndMgr.add(this.volumeWnd)):this.wndMgr.moveToTop(this.volumeWnd)}openAboutWnd(){null==this.aboutWnd?this.aboutWnd=new r.AboutWnd(this.wndMgr,(()=>{this.aboutWnd=null})):this.wndMgr.moveToTop(this.aboutWnd)}setUpBlur(){window.addEventListener("blur",(()=>{r.VolumeWnd.onFocusChanged(!1)})),window.addEventListener("focus",(()=>{r.VolumeWnd.onFocusChanged(!0)}))}}window.addEventListener("load",(()=>{l.default.setKeyPrefix("nesemu:"),o.default.setUp();const t=document.getElementById("nesroot");null!=t&&new g(t)}))},8635:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Apu=e.kChannelTypes=void 0;const i=s(5285),r=16384;e.kChannelTypes=[0,0,1,3,4];const n=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],a=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],o=[.125,.25,.5,-.25];class h{constructor(){this.status=new Uint8Array(2),this.tmp=new Uint8Array(2)}setStatus(t,e){192==(192&e)&&(e&=-193),48==(48&e)&&(e&=-49),this.status[t]=e}latch(){this.tmp[0]=this.status[0],this.tmp[1]=this.status[1]}shift(t){const e=this.tmp[t];return this.tmp[t]=e>>1,1&e}}class l{constructor(){this.regs=new Uint8Array(4),this.stopped=!0}reset(){this.regs.fill(0),this.stopped=!0}write(t,e){this.regs[t]=e}getVolume(){return 0}getFrequency(){return 0}getDutyRatio(){return.5}setEnable(t){t||(this.stopped=!0)}update(){}isPlaying(){return!this.stopped}}class c extends l{constructor(){super(...arguments),this.lengthCounter=0,this.sweepCounter=0,this.envelopeDivider=0,this.envelopeCounter=0,this.envelopeReset=!1}reset(){super.reset(),this.sweepCounter=0,this.envelopeDivider=this.envelopeCounter=0}write(t,e){switch(super.write(t,e),t){case 0:this.stopped=!1,0==(16&e)&&(this.envelopeDivider=15&e,this.envelopeCounter=15);break;case 1:this.sweepCounter=e>>4&7;break;case 3:this.lengthCounter=n[e>>3],this.stopped=!1,this.envelopeReset=!0}}getVolume(){if(this.stopped)return 0;const t=this.regs[0];return 0!=(16&t)?(15&t)/15:this.envelopeCounter/15}getFrequency(){return 111860.8125/(this.regs[2]+((7&this.regs[3])<<8)+1)|0}getDutyRatio(){return o[this.regs[0]>>6&3]}update(){this.stopped||(this.updateLength(),this.updateEnvelope(),this.sweep())}updateLength(){if(0!=(32&this.regs[0]))return;let t=this.lengthCounter;t<=0?(t=0,this.stopped=!0):(t-=4,t<0&&(t=0)),this.lengthCounter=t}updateEnvelope(){if(0==(16&this.regs[0]))return this.envelopeReset?(this.envelopeReset=!1,this.envelopeCounter=15,void(this.envelopeDivider=15&this.regs[0])):(this.envelopeDivider-=4,void(this.envelopeDivider<=0&&(this.envelopeDivider+=15&this.regs[0],this.envelopeCounter>0?--this.envelopeCounter:0!=(32&this.regs[0])?this.envelopeCounter=15:this.envelopeCounter=0)))}sweep(){const t=this.regs[1];if(0==(128&t))return;let e=this.sweepCounter;e+=2;const s=t>>4&7;if(e>=s){e-=s;let i=this.regs[2]+((7&this.regs[3])<<8);const r=7&t;if(r>0){const e=i>>r;0==(8&t)?(i+=e,i>2047&&(this.stopped=!0)):(i-=e,i<8&&(this.stopped=!0)),this.regs[2]=255&i,this.regs[3]=-8&this.regs[3]|(1792&i)>>8}e-=2,e<=0&&(this.sweepCounter=(t>>4&7)+e)}this.sweepCounter=e}}class u extends l{constructor(){super(...arguments),this.lengthCounter=0}write(t,e){switch(super.write(t,e),t){case 0:case 3:this.lengthCounter=127&this.regs[0],this.stopped=this.lengthCounter<=0}}getVolume(){return this.stopped?0:1}getFrequency(){return 55930.40625/(this.regs[2]+((7&this.regs[3])<<8)+1)|0}update(){this.stopped||this.updateLength()}updateLength(){if(0!=(128&this.regs[0]))return;let t=this.lengthCounter;t<=0?(t=0,this.stopped=!0):(t-=4,t<=0&&(t=0)),this.lengthCounter=t}}class d extends l{constructor(){super(...arguments),this.lengthCounter=0}write(t,e){switch(super.write(t,e),t){case 3:this.lengthCounter=n[e>>3],this.stopped=!1}}getVolume(){if(this.stopped)return 0;const t=this.regs[0];return 0!=(16&t)?(15&t)/15:1}getFrequency(){const t=15&this.regs[2];return a[t]}update(){this.stopped||this.updateLength()}updateLength(){if(0!=(32&this.regs[0]))return;let t=this.lengthCounter;t<=0?(t=0,0==(128&this.regs[2])&&(this.stopped=!0)):(t-=1,t<0&&(t=0)),this.lengthCounter=t}}class p extends l{constructor(t){super(),this.triggerIrq=t,this.regsLengthCounter=1,this.dmaLengthCounter=0}setEnable(t){this.stopped=!t,t?0===this.dmaLengthCounter&&(this.dmaLengthCounter=this.regsLengthCounter):this.dmaLengthCounter=0}write(t,e){switch(super.write(t,e),t){case 3:this.regsLengthCounter=8*(1+(e<<4)),this.stopped=!1}}getVolume(){if(this.stopped)return 0;const t=this.regs[0];return 0!=(16&t)?(15&t)/15:1}getFrequency(){const t=15&this.regs[2];return a[t]}update(){this.stopped}onHblank(t){this.updateLength()}updateLength(){if(this.stopped)return;let t=this.dmaLengthCounter;t<=0?(t=0,0==(64&this.regs[0])?(this.stopped=!0,0!=(128&this.regs[0])&&this.triggerIrq()):t=this.regsLengthCounter):(t-=1,t<0&&(t=0)),this.dmaLengthCounter=t}}e.Apu=class{constructor(t){this.triggerIrq=t,this.regs=new Uint8Array(32),this.channels=new Array(5),this.frameInterrupt=0,this.dmcInterrupt=128,this.gamePad=new h,this.channels[0]=new c,this.channels[1]=new c,this.channels[2]=new u,this.channels[3]=new d,this.channels[4]=new p(t)}getChannelTypes(){return e.kChannelTypes}reset(){this.regs.fill(0),this.regs[23]=64,this.frameInterrupt=0,this.dmcInterrupt=128,this.channels.forEach((t=>{t.reset()}))}save(){return{regs:i.default.convertUint8ArrayToBase64String(this.regs)}}load(t){const e=i.default.convertBase64StringToUint8Array(t.regs);for(let t=0;t<e.length;++t)this.write(t+r,e[t])}read(t){const e=t-r;switch(e){case 21:{let t=this.dmcInterrupt|this.frameInterrupt;for(let e=0;e<5;++e)0!=(this.regs[21]&1<<e)&&this.channels[e].isPlaying()&&(t|=1<<e);return this.frameInterrupt=0,t}case 22:case 23:return this.gamePad.shift(e-22);default:return 0}}write(t,e){const s=t-r;if(!(s>=32)){if(this.regs[s]=e,s<20){const t=s>>2,i=3&s;this.channels[t].write(i,e)}switch(s){case 21:this.dmcInterrupt=0;for(let t=0;t<5;++t)this.channels[t].setEnable(0!=(e&1<<t));break;case 22:0==(1&e)&&this.gamePad.latch()}}}getVolume(t){return 0==(this.regs[21]&1<<t)?0:this.channels[t].getVolume()}getFrequency(t){return this.channels[t].getFrequency()}getDutyRatio(t){return this.channels[t].getDutyRatio()}setPadStatus(t,e){this.gamePad.setStatus(t,e)}onHblank(t){switch(this.channels[4].onHblank(t),t){case 241:this.channels.forEach((t=>t.update())),this.isIrqEnabled()&&(this.frameInterrupt=64,this.triggerIrq())}}isIrqEnabled(){return 0==(192&this.regs[23])}}},2245:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(5285),r=8192;e.default=class{constructor(){this.readerTable=new Array(8),this.writerTable=new Array(8),this.readErrorReported=!1,this.writeErrorReported=!1,this.clearMemoryMap()}clearMemoryMap(){this.readerTable.fill((t=>(this.readErrorReported||(console.error(`Illegal read at ${i.default.hex(t,4)}`),this.readErrorReported=!0),191))),this.writerTable.fill(((t,e)=>{if(!this.writeErrorReported){const s=i.default.hex(t,4),r=i.default.hex(e,2);console.error(`Illegal write at ${s}, ${r}`),this.writeErrorReported=!0}}))}setReadMemory(t,e,s){const i=e/r|0;for(let e=t/r|0;e<=i;++e)this.readerTable[e]=s}setWriteMemory(t,e,s){const i=e/r|0;for(let e=t/r|0;e<=i;++e)this.writerTable[e]=s}read8(t){const e=t/r|0;return(0,this.readerTable[e])(t)}write8(t,e){const s=t/r|0;return(0,this.writerTable[s])(t,e)}dump(t,e){const s=new Array;for(let i=0;i<e;++i)s.push(this.read8(i+t));for(let r=0;r<e;r+=16){const e=s.splice(0,16).map((t=>i.default.hex(t,2))).join(" ");console.log(`${i.default.hex(t+r,4)}: ${e}`)}}}},9763:(t,e)=>{"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.Const=void 0,(s=e.Const||(e.Const={})).WIDTH=256,s.HEIGHT=240},6435:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(4192),r=s(5285);e.default=class{constructor(t){this.bus=t,this.negative=0,this.overflow=0,this.reservedFlag=0,this.breakmode=0,this.decimal=0,this.irqBlocked=0,this.zero=0,this.carry=0,this.irqRequest=0,this.breakPoints=new Set,this.watchRead=new Set,this.watchWrite=new Set,this.paused=!1,this.a=this.x=this.y=this.s=0,this.pc=0,this.negative=this.overflow=this.decimal=this.zero=this.carry=0,this.irqBlocked=this.breakmode=this.reservedFlag=1}reset(){this.s=this.s-3&255,this.pc=this.read16(65532),this.irqBlocked=1}getRegs(){return{a:this.a,x:this.x,y:this.y,s:this.s,p:this.getStatusReg(),pc:this.pc}}save(){return this.getRegs()}load(t){this.a=t.a,this.x=t.x,this.y=t.y,this.s=t.s,this.pc=t.pc,this.setStatusReg(t.p)}deleteAllBreakPoints(){this.breakPoints.clear(),this.watchRead.clear(),this.watchWrite.clear()}pause(t){this.paused=t}isPaused(){return this.paused}nmi(){const t=this.read16(65530);this.breakPoints.has("nmi")&&(this.paused=!0,console.warn(`paused because NMI: ${r.default.hex(this.pc,4)}, ${r.default.hex(t,4)}`)),this.push16(this.pc),this.push(-17&this.getStatusReg()),this.pc=t,this.irqBlocked=1}requestIrq(t){this.irqRequest|=1<<t}clearIrqRequest(t){this.irqRequest&=~(1<<t)}step(){0!==this.irqRequest&&0===this.irqBlocked&&(this.irqRequest=0,this.handleIrq());let t=this.pc;const e=this.read8(t++),s=i.kInstTable[e];if(0===s.opType)return console.error(`Unknonwn OPCODE, ${r.default.hex(this.pc-1,4)}: ${r.default.hex(e,2)}`),this.paused=!0,0;this.pc+=s.bytes;const n=this.getAdr(t,s.addressing);let a=s.cycle;switch(s.opType){default:case 1:break;case 2:this.a=this.read8(n),this.setNZFlag(this.a);break;case 3:this.write8(n,this.a);break;case 4:this.x=this.read8(n),this.setNZFlag(this.x);break;case 5:this.write8(n,this.x);break;case 6:this.y=this.read8(n),this.setNZFlag(this.y);break;case 7:this.write8(n,this.y);break;case 8:this.x=this.a,this.setNZFlag(this.x);break;case 9:this.y=this.a,this.setNZFlag(this.y);break;case 10:this.a=this.x,this.setNZFlag(this.a);break;case 11:this.a=this.y,this.setNZFlag(this.a);break;case 12:this.s=this.x;break;case 13:this.x=this.s,this.setNZFlag(this.x);break;case 14:{const t=this.carry,e=this.read8(n),s=this.a+e+t,i=0!=((this.a^s)&(e^s)&128);this.a=255&s,this.setNZCFlag(this.a,s>=256),this.setOverFlow(i)}break;case 15:{const t=this.carry,e=255-this.read8(n),s=this.a+e+t,i=0!=((this.a^s)&(e^s)&128);this.a=255&s,this.setNZCFlag(this.a,s>=256),this.setOverFlow(i)}break;case 16:this.x=this.x+1&255,this.setNZFlag(this.x);break;case 17:this.y=this.y+1&255,this.setNZFlag(this.y);break;case 18:{const t=this.read8(n)+1&255;this.write8(n,t),this.setNZFlag(t)}break;case 19:this.x=this.x-1&255,this.setNZFlag(this.x);break;case 20:this.y=this.y-1&255,this.setNZFlag(this.y);break;case 21:{const t=this.read8(n)-1&255;this.write8(n,t),this.setNZFlag(t)}break;case 22:{const t=this.read8(n);this.a&=t,this.setNZFlag(this.a)}break;case 23:{const t=this.read8(n);this.a|=t,this.setNZFlag(this.a)}break;case 24:{const t=this.read8(n);this.a^=t,this.setNZFlag(this.a)}break;case 25:{const t=2===s.addressing,e=t?this.a:this.read8(n),i=e>=128,r=255&(e<<1|this.carry);t?this.a=r:this.write8(n,r),this.setNZCFlag(r,i)}break;case 26:{const t=2===s.addressing,e=t?this.a:this.read8(n),i=0!=(1&e),r=e>>1|this.carry<<7;t?this.a=r:this.write8(n,r),this.setNZCFlag(r,i)}break;case 27:{const t=2===s.addressing,e=t?this.a:this.read8(n),i=e>=128,r=e<<1&255;t?this.a=r:this.write8(n,r),this.setNZCFlag(r,i)}break;case 28:{const t=2===s.addressing,e=t?this.a:this.read8(n),i=0!=(1&e),r=e>>1&255;t?this.a=r:this.write8(n,r),this.setNZCFlag(r,i)}break;case 29:{const t=this.read8(n),e=this.a&t;this.zero=0===e?1:0,this.negative=t>>7&1,this.overflow=t>>6&1}break;case 30:{const t=this.read8(n),e=this.a-t;this.setNZCFlag(255&e,e>=0)}break;case 31:{const t=this.read8(n),e=this.x-t;this.setNZCFlag(255&e,e>=0)}break;case 32:{const t=this.read8(n),e=this.y-t;this.setNZCFlag(255&e,e>=0)}break;case 33:this.pc=n;break;case 34:this.push16(this.pc-1),this.pc=n;break;case 35:this.pc=this.pop16()+1;break;case 36:this.setStatusReg(32|this.pop()),this.pc=this.pop16();break;case 37:a+=this.branch(n,0===this.carry);break;case 38:a+=this.branch(n,0!==this.carry);break;case 39:a+=this.branch(n,0===this.negative);break;case 40:a+=this.branch(n,0!==this.negative);break;case 41:a+=this.branch(n,0===this.zero);break;case 42:a+=this.branch(n,0!==this.zero);break;case 43:a+=this.branch(n,0===this.overflow);break;case 44:a+=this.branch(n,0!==this.overflow);break;case 45:this.push(this.a);break;case 46:this.push(16|this.getStatusReg());break;case 47:this.a=this.pop(),this.setNZFlag(this.a);break;case 48:this.setStatusReg(32|this.pop());break;case 49:this.carry=0;break;case 50:this.carry=1;break;case 51:this.irqBlocked=1;break;case 52:this.irqBlocked=0;break;case 53:this.overflow=0;break;case 54:this.decimal=1;break;case 55:this.decimal=0;break;case 56:this.push16(this.pc+1),this.push(16|this.getStatusReg()),this.pc=this.read16(65534),this.irqBlocked=1}return this.breakPoints.has(this.pc)&&(this.paused=!0,console.warn(`paused because PC matched break point: ${r.default.hex(this.pc,4)}`)),a}getStatusReg(){return this.negative<<7|this.overflow<<6|this.reservedFlag<<5|this.breakmode<<4|this.decimal<<3|this.irqBlocked<<2|this.zero<<1|this.carry<<0}setStatusReg(t){this.negative=t>>7&1,this.overflow=t>>6&1,this.reservedFlag=t>>5&1,this.breakmode=t>>4&1,this.decimal=t>>3&1,this.irqBlocked=t>>2&1,this.zero=t>>1&1,this.carry=t>>0&1}read8(t){const e=this.bus.read8(t);return this.watchRead.has(t)&&(this.paused=!0,console.warn(`Break because watched point read: adr=${r.default.hex(t,4)}, value=${r.default.hex(e,2)}`)),e}read16(t){const e=this.read8(t);return this.read8(t+1)<<8|e}read16Indirect(t){const e=this.read8(t);return this.read8((65280&t)+(t+1&255))<<8|e}write8(t,e){this.bus.write8(t,e),this.watchWrite.has(t)&&(this.paused=!0,console.warn(`Break because watched point write: adr=${r.default.hex(t,4)}, value=${r.default.hex(e,2)}`))}push(t){this.write8(256+this.s,t),this.s=this.s-1&255}push16(t){let e=this.s;this.write8(256+e,t>>8),e=e-1&255,this.write8(256+e,255&t),this.s=e-1&255}pop(){return this.s=this.s+1&255,this.read8(256+this.s)}pop16(){let t=this.s;t=t+1&255;const e=this.read8(256+t);t=t+1&255;const s=this.read8(256+t);return this.s=t,s<<8|e}setNZFlag(t){this.zero=0===t?1:0,this.negative=t>=128?1:0}setNZCFlag(t,e){this.zero=0===t?1:0,this.negative=t>=128?1:0,this.carry=e?1:0}setOverFlow(t){this.overflow=t?1:0}getAdr(t,e){switch(e){case 2:case 1:return 0;case 3:case 14:return t;case 5:return this.read8(t);case 6:return this.read8(t)+this.x&255;case 7:return this.read8(t)+this.y&255;case 8:return this.read16(t);case 9:return this.read16(t)+this.x&65535;case 10:return this.read16(t)+this.y&65535;case 12:{const e=this.read8(t);return this.read16Indirect(e+this.x&255)}case 13:{const e=this.read8(t);return this.read16Indirect(e)+this.y&65535}case 11:{const e=this.read16(t);return this.read16Indirect(e)}default:return console.error(`Illegal addressing: ${e}`),this.paused=!0,0}}branch(t,e){if(!e)return 0;const s=this.pc,i=this.read8(t),r=s+(i<128?i:i-256)&65535;return this.pc=r,(256&(s^r))>0?2:1}handleIrq(){return this.push16(this.pc),this.push(-17&this.getStatusReg()),this.pc=this.read16(65534),this.irqBlocked=1,!0}}},4558:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.disasm=e.kOpcode=void 0;const i=s(4192),r=s(5285);function n(t,s,i,n){let a="";switch(t.addressing){case 1:case 2:break;case 3:a=` #$${r.default.hex(s[i],2)}`;break;case 4:a=` #$${r.default.hex(s[i]|s[i+1]<<8,4)}`;break;case 5:a=` $${r.default.hex(s[i],2)}`;break;case 6:a=` $${r.default.hex(s[i],2)}, X`;break;case 7:a=` $${r.default.hex(s[i],2)}, Y`;break;case 8:a=` $${r.default.hex(s[i]|s[i+1]<<8,4)}`;break;case 9:a=` $${r.default.hex(s[i]|s[i+1]<<8,4)}, X`;break;case 10:a=` $${r.default.hex(s[i]|s[i+1]<<8,4)}, Y`;break;case 11:a=` ($${r.default.hex(s[i]|s[i+1]<<8,4)})`;break;case 12:a=` ($${r.default.hex(s[i],2)}, X)`;break;case 13:a=` ($${r.default.hex(s[i],2)}), Y`;break;case 14:{const e=s[i];a=e<128?` +${e}  ; $${r.default.hex(n+t.bytes+e,4)}`:` ${e-256}  ; $${r.default.hex(n+t.bytes+e-256,4)}`}break;default:console.error(`Unhandled addressing: ${t.addressing}`)}return`${e.kOpcode[t.opType]}${a}`}e.kOpcode={2:"LDA",3:"STA",4:"LDX",5:"STX",6:"LDY",7:"STY",8:"TAX",9:"TAY",10:"TXA",11:"TYA",12:"TXS",13:"TSX",14:"ADC",15:"SBC",16:"INX",17:"INY",18:"INC",19:"DEX",20:"DEY",21:"DEC",22:"AND",23:"ORA",24:"EOR",25:"ROL",26:"ROR",27:"ASL",28:"LSR",29:"BIT",30:"CMP",31:"CPX",32:"CPY",33:"JMP",34:"JSR",35:"RTS",36:"RTI",37:"BCC",38:"BCS",39:"BPL",40:"BMI",41:"BNE",42:"BEQ",43:"BVC",44:"BVS",45:"PHA",46:"PHP",47:"PLA",48:"PLP",49:"CLC",50:"SEC",51:"SEI",52:"CLI",53:"CLV",54:"SED",55:"CLD",56:"BRK",1:"NOP"},e.default=n;const a=new Uint8Array(3),o=new Array(3);e.disasm=function(t,e){const s=t.read8(e),h=i.kInstTable[s]||i.kIllegalInstruction;for(let s=0;s<h.bytes;++s){const i=t.read8(e+s);a[s]=i,o[s]=r.default.hex(i,2)}for(let t=h.bytes;t<3;++t)o[t]="  ";return`${r.default.hex(e,4)}: ${o.join(" ")}   ${n(h,a,1,e)}`}},4192:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.kInstTable=e.kIllegalInstruction=void 0;const s=[[234,1,1,1,2],[169,2,3,2,2],[165,2,5,2,3],[181,2,6,2,4],[173,2,8,3,4],[189,2,9,3,4],[185,2,10,3,4],[161,2,12,2,6],[177,2,13,2,5],[133,3,5,2,3],[149,3,6,2,4],[141,3,8,3,4],[157,3,9,3,5],[153,3,10,3,5],[149,3,6,2,4],[129,3,12,2,6],[145,3,13,2,6],[162,4,3,2,2],[166,4,5,2,3],[182,4,7,2,4],[174,4,8,3,4],[190,4,10,3,4],[134,5,5,2,3],[150,5,7,2,4],[142,5,8,3,4],[160,6,3,2,2],[164,6,5,2,3],[180,6,6,2,4],[172,6,8,3,4],[188,6,9,3,4],[132,7,5,2,3],[148,7,6,2,4],[140,7,8,3,4],[170,8,1,1,2],[168,9,1,1,2],[138,10,1,1,2],[152,11,1,1,2],[154,12,1,1,2],[186,13,1,1,2],[105,14,3,2,2],[101,14,5,2,3],[117,14,6,2,4],[109,14,8,3,4],[125,14,9,3,4],[121,14,10,3,4],[97,14,12,2,6],[113,14,13,2,5],[233,15,3,2,2],[229,15,5,2,3],[245,15,6,2,4],[237,15,8,3,4],[253,15,9,3,4],[249,15,10,3,4],[225,15,12,2,6],[241,15,13,2,5],[201,30,3,2,2],[197,30,5,2,3],[213,30,6,2,4],[205,30,8,3,4],[221,30,9,3,4],[217,30,10,3,4],[193,30,12,2,6],[209,30,13,2,5],[224,31,3,2,2],[228,31,5,2,3],[236,31,8,3,4],[192,32,3,2,2],[196,32,5,2,3],[204,32,8,3,4],[232,16,1,1,2],[200,17,1,1,2],[230,18,5,2,5],[246,18,6,2,6],[238,18,8,3,6],[254,18,9,3,7],[202,19,1,1,2],[136,20,1,1,2],[198,21,5,2,5],[214,21,6,2,6],[206,21,8,3,6],[222,21,9,3,7],[41,22,3,2,2],[37,22,5,2,3],[53,22,6,2,4],[45,22,8,3,4],[61,22,9,3,4],[57,22,10,3,4],[33,22,12,2,6],[49,22,13,2,5],[9,23,3,2,2],[5,23,5,2,3],[21,23,6,2,4],[13,23,8,3,4],[29,23,9,3,4],[25,23,10,3,4],[1,23,12,2,6],[17,23,13,2,5],[73,24,3,2,2],[69,24,5,2,3],[85,24,6,2,4],[77,24,8,3,4],[93,24,9,3,4],[89,24,10,3,4],[65,24,12,2,6],[81,24,13,2,5],[42,25,2,1,2],[38,25,5,2,5],[54,25,6,2,6],[46,25,8,3,6],[62,25,9,3,7],[106,26,2,1,2],[102,26,5,2,5],[118,26,6,2,6],[110,26,8,3,6],[126,26,9,3,7],[10,27,2,1,2],[6,27,5,2,5],[22,27,6,2,6],[14,27,8,3,6],[30,27,9,3,7],[74,28,2,1,2],[70,28,5,2,5],[86,28,6,2,6],[78,28,8,3,6],[94,28,9,3,7],[36,29,5,2,3],[44,29,8,3,4],[76,33,8,3,3],[108,33,11,3,5],[32,34,8,3,6],[96,35,1,1,6],[64,36,1,1,6],[144,37,14,2,2],[176,38,14,2,2],[16,39,14,2,2],[48,40,14,2,2],[208,41,14,2,2],[240,42,14,2,2],[80,43,14,2,2],[112,44,14,2,2],[72,45,1,1,3],[8,46,1,1,3],[104,47,1,1,4],[40,48,1,1,4],[24,49,1,1,2],[56,50,1,1,2],[120,51,1,1,2],[88,52,1,1,2],[184,53,1,1,2],[248,54,1,1,2],[216,55,1,1,2],[0,56,1,1,7],[26,1,1,1,2],[58,1,1,1,2],[90,1,1,1,2],[122,1,1,1,2],[218,1,1,1,2],[250,1,1,1,2],[4,1,1,2,3],[68,1,1,2,3],[100,1,1,2,3],[20,1,1,2,4],[52,1,1,2,4],[84,1,1,2,4],[116,1,1,2,4],[212,1,1,2,4],[244,1,1,2,4],[12,1,1,1,4],[28,1,1,3,4],[60,1,1,3,4],[92,1,1,3,4],[124,1,1,3,4],[220,1,1,3,4],[252,1,1,3,5],[128,1,1,2,2],[130,1,1,2,2],[137,1,1,2,2],[194,1,1,2,2],[226,1,1,2,2]];e.kIllegalInstruction={opType:0,addressing:0,bytes:1,cycle:0},e.kInstTable=(()=>{const t=new Array(256);return t.fill(e.kIllegalInstruction),s.forEach((e=>{const[s,i,r,n,a]=e;t[s]={opType:i,addressing:r,bytes:n,cycle:a}})),t})()},1522:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(1693);e.default=class{constructor(t,e){this.nes=e;const s=this.nes.getBus(),r=this.nes.getCpu(),n=this.nes.getPpu();this.mapper=new i.Mapper020(t,{bus:s,cpu:r,ppu:n,prgBankCtrl:this,prgSize:t.length}),this.mapper.setUp(e),this.nes.setMapper(this.mapper)}setImage(t){return this.mapper.setImage(t),!0}getSideCount(){return this.mapper.getSideCount()}eject(){this.mapper.eject()}setSide(t){this.mapper.setSide(t)}setPrgBank(t,e){}}},1693:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper020=void 0;const i=s(1197);class r extends i.Mapper{constructor(t,e){super(),this.biosData=t,this.options=e,this.ram=new Uint8Array(32768),this.regs=new Uint8Array(16),this.diskSideImages=new Array,this.headPointer=0,this.irqCounter=0,this.timerIrqOccurred=!1,this.transferComplete=!1,this.endOfHead=!0,this.scanningDisk=!1,this.delay=0,this.readData=0,this.options.ppu.setChrData(Uint8Array.from([])),this.options.ppu.setMirrorMode(0),this.options.bus.setReadMemory(57344,65535,(t=>(t|=0,0|this.biosData[t-57344]))),this.reset()}reset(){this.headPointer=0,this.irqCounter=0,this.regs.fill(0),this.timerIrqOccurred=!1,this.transferComplete=!1,this.readData=0,this.endOfHead=!0,this.scanningDisk=!1,this.delay=0}setUp(t){this.nes=t,this.options.bus.setReadMemory(16384,24575,(t=>16432<=t&&t<=16447?this.readDiskReg(t):this.nes.readFromApu(t))),this.options.bus.setWriteMemory(16384,24575,((t,e)=>{if(16416<=t&&t<=16431)return this.writeDiskReg(t,e);this.nes.writeToApu(t,e)})),this.ram.fill(191),this.options.bus.setReadMemory(24576,57343,(t=>this.ram[t-24576])),this.options.bus.setWriteMemory(24576,57343,((t,e)=>{this.ram[t-24576]=e}))}setImage(t){return 70===t[0]&&68===t[1]&&83===t[2]&&26===t[3]&&(t=t.slice(16)),this.diskSideImages=function(t){const e=65500,s=t.length/e,i=[],r=new Array;for(let n=0;n<s;++n){const s=n*e;i.length=0;let a=0;for(let r=0;r<e;){let e=-1;switch(t[r+s]){case 1:e=56;break;case 2:e=2;break;case 3:e=16;break;case 4:e=1+(t[r-2+s]<<8|t[r-3+s])}if(e<=0)break;i.push([r+s,e]),a+=e,r+=e}const o=a+2*i.length+1,h=new Uint8Array(o);let l=0;for(const[e,s]of i){for(let i=0;i<s;++i)h[l+i]=t[e+i];l+=s,h[l+0]=h[l+1]=0,l+=2}h[l-1]=0,r.push(h)}return r}(t),this.image=this.diskSideImages[0],!0}getSideCount(){return this.diskSideImages.length}onHblank(t){if(0!=(2&this.regs[2])&&0!=(1&this.regs[3])&&(this.irqCounter-=185,this.irqCounter<=0&&(this.options.cpu.requestIrq(1),this.timerIrqOccurred=!0,console.log(`IRQ!, repeat=${0!=(1&this.regs[2])}, nextCounter=${this.regs[1]<<8|this.regs[0]}`),0!=(1&this.regs[2])?this.irqCounter=this.regs[1]<<8|this.regs[0]:(this.irqCounter=0,this.regs[2]&=-3))),null==this.image||0==(1&this.regs[5]))return this.endOfHead=!0,void(this.scanningDisk=!1);if(0==(2&this.regs[5])||this.scanningDisk){if(this.endOfHead)return this.delay=5,this.endOfHead=!1,void(this.headPointer=0);if(this.delay>0)--this.delay;else{this.scanningDisk=!0;const t=0!=(128&this.regs[5]),e=this.image[this.headPointer];this.transferComplete=!0,this.readData=e,t&&this.options.cpu.requestIrq(2)}}}eject(){delete this.image,this.headPointer=0}setSide(t){this.image=this.diskSideImages[t%this.diskSideImages.length]}readDiskReg(t){switch(t-16432|0){case 0:{let t=0;return this.image&&(t=128,this.timerIrqOccurred&&(t|=1,this.timerIrqOccurred=!1),this.transferComplete&&(t|=2,this.transferComplete=!1)),t}case 1:{let t=0;return 0!=(4&this.regs[5])?(t=this.readData,++this.headPointer,this.headPointer>=this.image.length&&(this.regs[5]&=-2)):console.log("READ_DATA with write"),this.transferComplete=!1,t}case 2:{let t=7;return null!=this.image&&(t=0,this.scanningDisk||(t|=2)),t}case 3:return this.regs[6]}return 0}writeDiskReg(t,e){const s=t-16416|0;switch(this.regs[s]=e,s){case 2:0!=(2&e)?this.irqCounter=this.regs[1]<<8|this.regs[0]:(this.irqCounter=0,this.timerIrqOccurred=!1);break;case 3:0==(1&e)&&(this.irqCounter=0,this.timerIrqOccurred=!1);break;case 4:this.transferComplete=!1;break;case 5:this.options.ppu.setMirrorMode(0!=(8&e)?0:1),0==(1&e)&&(this.endOfHead=!0,this.scanningDisk=!1)}}}e.Mapper020=r},1197:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper=void 0,e.Mapper=class{reset(){}onHblank(t){}save(){return{}}load(t){}getExtraSoundChannelTypes(){return[]}getSoundVolume(t){return 0}getSoundFrequency(t){return 0}getSoundDutyRatio(t){return.5}}},5226:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper000=void 0;const i=s(1197);class r extends i.Mapper{static create(t){return new r}}e.Mapper000=r},6187:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper001=void 0;const i=s(1197),r=s(5285),n=[2,3,1,0];class a extends i.Mapper{constructor(t){super(),this.options=t,this.maxPrg=0,this.ram=new Uint8Array(8192),this.register=0,this.counter=0,this.prgBankMode=3,this.prgReg=0,this.chrBank4k=!0,this.chrBank=[0,4],this.maxPrg=(t.prgSize>>14)-1,this.options.bus.setWriteMemory(32768,65535,((t,e)=>{if(0==(128&e)){if(this.register|=(1&e)<<this.counter,!(++this.counter<5)){switch(57344&t){case 32768:{this.options.ppu.setMirrorMode(n[3&this.register]),this.prgBankMode=this.register>>2&3,this.setPrgBank(this.prgReg,this.chrBank[0]);const t=0!=(16&this.register);this.chrBank4k!==t&&(this.chrBank4k=t,this.setChrBank(0,this.chrBank[0]),this.setChrBank(1,this.chrBank[1]))}break;case 40960:{const t=this.register;this.chrBank[0]!==t&&this.setChrBank(0,t),this.setPrgBank(this.prgReg,t)}break;case 49152:{const t=this.register;this.chrBank[1]!==t&&this.setChrBank(1,t)}break;case 57344:this.setPrgBank(this.register,this.chrBank[0])}this.resetRegister()}}else this.resetRegister()})),this.ram.fill(191),this.options.bus.setReadMemory(24576,32767,(t=>this.ram[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{this.ram[8191&t]=e})),this.setPrgBank(0,255)}static create(t){return new a(t)}save(){return{ram:r.default.convertUint8ArrayToBase64String(this.ram),register:this.register,counter:this.counter,prgBankMode:this.prgBankMode,prgReg:this.prgReg,chrBank4k:this.chrBank4k,chrBank:this.chrBank}}load(t){this.ram=r.default.convertBase64StringToUint8Array(t.ram),this.register=t.register,this.counter=t.counter,this.prgBankMode=t.prgBankMode,this.chrBank4k=t.chrBank4k;for(let e=0;e<2;++e)this.setChrBank(e,t.chrBank[e]);this.setPrgBank(t.prgReg,this.chrBank[0])}resetRegister(){this.register=0,this.counter=0}setChrBank(t,e){if(this.chrBank4k){const s=t<<2,i=e<<2;for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(s+t,i+t)}else 0===t&&this.options.ppu.setChrBank(e>>1);this.chrBank[t]=e}setPrgBank(t,e){this.prgReg=t;const s=16&e&this.maxPrg,i=(15&t|s)&this.maxPrg;let r,n;switch(this.prgBankMode){case 0:case 1:r=-2&i,n=1|i;break;case 2:r=0,n=i;break;case 3:r=i,n=15&this.maxPrg|s;break;default:return}this.options.prgBankCtrl.setPrgBank(0,r<<1),this.options.prgBankCtrl.setPrgBank(1,1+(r<<1)),this.options.prgBankCtrl.setPrgBank(2,n<<1),this.options.prgBankCtrl.setPrgBank(3,1+(n<<1))}}e.Mapper001=a},6600:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper093=e.Mapper002=void 0;const i=s(1197);class r extends i.Mapper{constructor(t,e){super(),this.options=e,this.bank=0;const s=e.prgSize>>14;this.options.prgBankCtrl.setPrgBank(0,0),this.options.prgBankCtrl.setPrgBank(1,1),this.options.prgBankCtrl.setPrgBank(2,2*s-2),this.options.prgBankCtrl.setPrgBank(3,2*s-1),this.options.bus.setWriteMemory(32768,65535,((e,s)=>{const i=s>>t<<1;this.setBank(i)}))}save(){return{bank:this.bank}}load(t){this.setBank(t.bank)}setBank(t){this.bank=t,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}}class n extends r{static create(t){return new n(t)}constructor(t){super(0,t)}}e.Mapper002=n;class a extends r{static create(t){return new a(t)}constructor(t){super(4,t)}}e.Mapper093=a},647:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper185=e.Mapper003=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t,this.chrBank=0,this.options.bus.setWriteMemory(32768,65535,((t,e)=>{this.chrBank=e,this.options.ppu.setChrBank(this.chrBank)}))}static create(t){return new r(t)}save(){return{chrBank:this.chrBank}}load(t){this.chrBank=t.chrBank,this.options.ppu.setChrBank(this.chrBank)}}e.Mapper003=r;class n extends r{static create(t){return new n(t)}constructor(t){super(t),t.ppu.writePpuDirect(0,1)}}e.Mapper185=n},8638:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper118=e.Mapper095=e.Mapper088=e.Mapper004=void 0;const i=s(1197),r=s(5285);class n extends i.Mapper{constructor(t){super(),this.options=t,this.regs=new Uint8Array(8),this.ram=new Uint8Array(8192),this.maxPrg=0,this.bankSelect=0,this.irqHlineEnable=!1,this.irqHlineValue=-1,this.irqHlineCounter=-1,this.irqLatch=0,this.maxPrg=(t.prgSize>>13)-1,this.options.prgBankCtrl.setPrgBank(3,this.maxPrg),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,(t=>this.ram[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{this.ram[8191&t]=e})),this.options.bus.setWriteMemory(32768,40959,((t,e)=>{if(0==(1&t))this.bankSelect=e,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect);else{const t=7&this.bankSelect;this.regs[t]=e,t<6?this.setChrBank(this.bankSelect):this.setPrgBank(this.bankSelect)}})),this.options.bus.setWriteMemory(40960,49151,((t,e)=>{0==(1&t)&&this.options.ppu.setMirrorMode(0==(1&e)?1:0)})),this.options.bus.setWriteMemory(49152,57343,((t,e)=>{0==(1&t)?(this.irqLatch=e,this.setIrqHlineValue(this.irqLatch)):this.setIrqHlineValue(this.irqLatch)})),this.options.bus.setWriteMemory(57344,65535,((t,e)=>{0==(1&t)?(this.enableIrqHline(!1),this.resetIrqHlineCounter()):this.enableIrqHline(!0)})),this.setPrgBank(this.bankSelect);let e=1;switch(this.options.romHash){case"6c0cd447297e95e45db35a4373dbeae1":case"e791b12fc3419a2e2f8a5ed64b210d72":case"44c206c61ff37406815f21b922e105c7":case"98b3778d1e6045d2a3350eb7eb3b39fc":e=0}this.options.ppu.setMirrorMode(e)}static create(t){return new n(t)}reset(){this.irqHlineEnable=!1,this.irqHlineValue=this.irqHlineCounter=-1}save(){return{regs:r.default.convertUint8ArrayToBase64String(this.regs),ram:r.default.convertUint8ArrayToBase64String(this.ram),bankSelect:this.bankSelect,irqHlineEnable:this.irqHlineEnable,irqHlineValue:this.irqHlineValue,irqHlineCounter:this.irqHlineCounter,irqLatch:this.irqLatch}}load(t){this.regs=r.default.convertBase64StringToUint8Array(t.regs),this.ram=r.default.convertBase64StringToUint8Array(t.ram),this.bankSelect=t.bankSelect,this.irqHlineEnable=t.irqHlineEnable,this.irqHlineValue=t.irqHlineValue,this.irqHlineCounter=t.irqHlineCounter,this.irqLatch=t.irqLatch,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect)}onHblank(t){switch(0!=(24&this.options.ppu.getRegs()[1])&&0==--this.irqHlineCounter&&this.irqHlineEnable&&this.options.cpu.requestIrq(1),t){case 0:this.irqHlineCounter=this.irqHlineValue}}setPrgBank(t){0==(64&t)?(this.options.prgBankCtrl.setPrgBank(0,this.regs[6]),this.options.prgBankCtrl.setPrgBank(1,this.regs[7]),this.options.prgBankCtrl.setPrgBank(2,this.maxPrg-1)):(this.options.prgBankCtrl.setPrgBank(2,this.regs[6]),this.options.prgBankCtrl.setPrgBank(1,this.regs[7]),this.options.prgBankCtrl.setPrgBank(0,this.maxPrg-1))}setChrBank(t){0==(128&t)?(this.options.ppu.setChrBankOffset(0,254&this.regs[0]),this.options.ppu.setChrBankOffset(1,1|this.regs[0]),this.options.ppu.setChrBankOffset(2,254&this.regs[1]),this.options.ppu.setChrBankOffset(3,1|this.regs[1]),this.options.ppu.setChrBankOffset(4,this.regs[2]),this.options.ppu.setChrBankOffset(5,this.regs[3]),this.options.ppu.setChrBankOffset(6,this.regs[4]),this.options.ppu.setChrBankOffset(7,this.regs[5])):(this.options.ppu.setChrBankOffset(4,254&this.regs[0]),this.options.ppu.setChrBankOffset(5,1|this.regs[0]),this.options.ppu.setChrBankOffset(6,254&this.regs[1]),this.options.ppu.setChrBankOffset(7,1|this.regs[1]),this.options.ppu.setChrBankOffset(0,this.regs[2]),this.options.ppu.setChrBankOffset(1,this.regs[3]),this.options.ppu.setChrBankOffset(2,this.regs[4]),this.options.ppu.setChrBankOffset(3,this.regs[5]))}setIrqHlineValue(t){this.irqHlineValue=t,this.irqHlineCounter=this.irqHlineValue}enableIrqHline(t){this.irqHlineEnable=t}resetIrqHlineCounter(){this.irqHlineCounter=0}}e.Mapper004=n;class a extends n{constructor(t){super(t),this.options=t,this.options.bus.setWriteMemory(32768,40959,((t,e)=>{if(0==(1&t))this.bankSelect=7&e,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect);else{const t=7&this.bankSelect;t<6?(e&=63,t>=2&&(e|=64),this.regs[t]=e,this.setChrBank(this.bankSelect)):(this.regs[t]=e,this.setPrgBank(this.bankSelect))}}))}static create(t){return new a(t)}}e.Mapper088=a;const o=[2,4,0,3];class h extends n{constructor(t){super(t),this.options=t,this.options.bus.setWriteMemory(32768,40959,((t,e)=>{if(0==(1&t))this.bankSelect=7&e;else{const t=7&this.bankSelect;if(t<6){if(this.regs[t]=63&e,this.setChrBank(0),0===t||1===t){const t=this.regs[0]>>5&1,e=this.regs[1]>>4&2;this.options.ppu.setMirrorMode(o[e|t])}}else this.regs[t]=31&e,this.setPrgBank(0)}}))}static create(t){return new h(t)}}e.Mapper095=h;class l extends n{static create(t){return new l(t)}constructor(t){super(t),this.options.bus.setWriteMemory(32768,40959,((t,e)=>{if(0==(1&t))this.bankSelect=e,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect);else{const t=7&this.bankSelect;this.regs[t]=127&e,t<6?this.setChrBank(this.bankSelect):this.setPrgBank(this.bankSelect);const s=128&this.regs[0],i=7&this.regs[0];(0===s&&i<2||0!==s&&i>=2&&i<6)&&this.options.ppu.setMirrorMode(0==(128&e)?2:3)}}))}}e.Mapper118=l},6778:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper007=void 0;const i=s(1197),r=[2,3];class n extends i.Mapper{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(32768,65535,((t,e)=>{const s=e<<2;for(let t=0;t<4;++t)this.options.prgBankCtrl.setPrgBank(t,s+t);const i=e>>4&1;this.options.ppu.setMirrorMode(r[i])}))}static create(t){return new n(t)}}e.Mapper007=n},7880:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper010=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(40960,49151,((t,e)=>{if(t<45056){const t=e<<1;this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}else this.options.ppu.setChrBank(e)})),this.options.bus.setWriteMemory(57344,61440,((t,e)=>{t>=61440&&this.options.ppu.setMirrorMode(0==(1&e)?1:0)}));const e=new Uint8Array(8192);e.fill(191),this.options.bus.setReadMemory(24576,32767,(t=>e[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,s)=>{e[8191&t]=s}))}static create(t){return new r(t)}}e.Mapper010=r},4616:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper016=void 0;const i=s(1197),r=s(5285),n=[1,0,2,3];class a extends i.Mapper{constructor(t){super(),this.options=t,this.prgBank=0,this.chrBank=new Uint8Array(8),this.irqEnable=!1,this.irqValue=0,this.irqCounter=0;const e=t.prgSize/16384;this.options.prgBankCtrl.setPrgBank(2,2*e-2),this.options.prgBankCtrl.setPrgBank(3,2*e-1),this.setPrgBank(0),this.options.bus.setWriteMemory(24576,65535,((t,s)=>{const i=15&t;switch(i){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.chrBank[i]=s,this.setChrBank(i,s);break;case 8:this.prgBank=s&e-1,this.setPrgBank(this.prgBank);break;case 9:this.options.ppu.setMirrorMode(n[3&s]);break;case 10:this.irqEnable=0!=(1&s);break;case 11:case 12:{const t=8*(i-11);this.irqValue=this.irqValue&65280>>t|s<<t,this.irqCounter=this.irqValue}break;default:console.log(`Write ${r.default.hex(t,4)}, ${r.default.hex(s,2)}`)}}))}static create(t){return new a(t)}reset(){this.irqEnable=!1,this.irqValue=this.irqCounter=0}save(){return{prgBank:this.prgBank,chrBank:r.default.convertUint8ArrayToBase64String(this.chrBank),irqEnable:this.irqEnable,irqValue:this.irqValue,irqCounter:this.irqCounter}}load(t){this.prgBank=t.prgBank,this.chrBank=r.default.convertBase64StringToUint8Array(t.chrBank),this.irqEnable=t.irqEnable,this.irqValue=t.irqValue,this.irqCounter=t.irqCounter,this.setPrgBank(this.prgBank);for(let t=0;t<this.chrBank.length;++t)this.setChrBank(t,this.chrBank[t])}onHblank(t){this.irqEnable&&(this.irqCounter-=115,this.irqCounter<=0&&(this.irqCounter+=this.irqValue,this.options.cpu.requestIrq(1)))}setPrgBank(t){this.options.prgBankCtrl.setPrgBank(0,2*t),this.options.prgBankCtrl.setPrgBank(1,2*t+1)}setChrBank(t,e){this.options.ppu.setChrBankOffset(t,e)}}e.Mapper016=a},3352:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper019=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(32768,49151,((t,e)=>{const s=t>>11&7;this.options.ppu.setChrBankOffset(s,e)})),this.options.bus.setWriteMemory(57344,65535,((t,e)=>{if(t<=63487){const s=(t-57344)/2048;this.options.prgBankCtrl.setPrgBank(s,e)}}))}static create(t){return new r(t)}}e.Mapper019=r},4463:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper025=e.Mapper023=void 0;const i=s(1197),r=s(5285),n=[1,0,2,3];class a extends i.Mapper{constructor(t,e){super(),this.options=t,this.ram=new Uint8Array(8192),this.prgBankMode=0,this.prgBank=new Array(4),this.chrBank=new Array(8),this.irqControl=0,this.irqLatch=0,this.irqCounter=0;const s=t.prgSize>>13;this.setPrgBank(0,0),this.setPrgBank(1,1),this.setPrgBank(2,s-2),this.setPrgBank(3,s-1),this.options.bus.setWriteMemory(32768,40959,((t,i)=>{if(32768<=t&&t<=32774)switch(this.prgBankMode){case 0:this.setPrgBank(0,i);break;case 1:this.setPrgBank(2,i)}else if(36864==(65280&t)){const r=e[255&t];if(0===r||2===r){const t=3&i;this.options.ppu.setMirrorMode(n[t])}else if(4===r||6===r)switch(this.prgBankMode=i>>1&1,this.prgBankMode){case 0:this.setPrgBank(2,s-2);break;case 1:this.setPrgBank(0,s-2)}}})),this.options.bus.setWriteMemory(40960,49151,((t,i)=>{if(40960<=t&&t<=40966)this.setPrgBank(1,i&s-1);else if(45056==(65280&t)){const s=e[255&t];0===s?this.setChrBankOffset(0,-16&this.chrBank[0]|15&i):2===s?this.setChrBankOffset(0,-497&this.chrBank[0]|(31&i)<<4):4===s?this.setChrBankOffset(1,-16&this.chrBank[1]|15&i):6===s&&this.setChrBankOffset(1,-497&this.chrBank[1]|(31&i)<<4)}})),this.options.bus.setWriteMemory(49152,65535,((t,s)=>{if(49152<=t&&t<=61439){const i=e[255&t];let r=0,n=!1;if(0===i)r=0;else if(2===i)r=0,n=!0;else if(4===i)r=1;else{if(6!==i)return;r=1,n=!0}const a=2+((12288&t)>>11)+r;let o;o=n?-497&this.chrBank[a]|(31&s)<<4:-16&this.chrBank[a]|15&s,this.setChrBankOffset(a,o)}else{const i=e[255&t];if(0===i)this.irqLatch=-16&this.irqLatch|15&s;else if(2===i)this.irqLatch=-241&this.irqLatch|(15&s)<<4;else if(4===i)this.irqControl=s,0!=(2&this.irqControl)&&(this.irqCounter=this.irqLatch);else if(6===i){const t=1&this.irqControl;this.irqControl=-3&this.irqControl|t<<1}}})),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,(t=>this.ram[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{this.ram[8191&t]=e}))}reset(){this.irqControl=0,this.irqLatch=this.irqCounter=0}save(){return{ram:r.default.convertUint8ArrayToBase64String(this.ram),prgBankMode:this.prgBankMode,prgBank:this.prgBank,chrBank:this.chrBank,irqControl:this.irqControl,irqLatch:this.irqLatch,irqCounter:this.irqCounter}}load(t){this.ram=r.default.convertBase64StringToUint8Array(t.ram),this.prgBankMode=t.prgBankMode,this.irqControl=t.irqControl,this.irqLatch=t.irqLatch,this.irqCounter=t.irqCounter;for(let e=0;e<4;++e)this.setPrgBank(e,t.prgBank[e]);for(let e=0;e<8;++e)this.setChrBankOffset(e,t.chrBank[e])}onHblank(t){if(0!=(2&this.irqControl)){let t=this.irqCounter;0==(4&this.irqControl)?t+=1:t+=185,t>255&&(t=this.irqLatch,this.options.cpu.requestIrq(1)),this.irqCounter=t}}setPrgBank(t,e){this.prgBank[t]=e,this.options.prgBankCtrl.setPrgBank(t,e)}setChrBankOffset(t,e){this.chrBank[t]=e,this.options.ppu.setChrBankOffset(t,e)}}class o extends a{static create(t){return new o(t)}constructor(t){super(t,{0:0,4:2,8:4,12:6,1:2,2:4,3:6})}}e.Mapper023=o;class h extends a{static create(t){return new h(t)}constructor(t){super(t,{0:0,1:4,2:2,3:6})}}e.Mapper025=h},8249:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper026=e.Mapper024=void 0;const i=s(1197),r=s(5285),n=128,a=[1,0,2,3],o=[[0,1,2,3,4,5,6,7],[0,0,1,1,2,2,3,3],[0,1,2,3,4,4,5,5],[0,1,2,3,4,4,5,5]],h=[0,0,2];class l{constructor(){this.regs=new Uint8Array(4)}write(t,e){this.regs[t]=e}update(){}getVolume(){return 0}getFrequency(){return 0}getDutyRatio(){return.5}}class c extends l{getVolume(){return 0==(this.regs[2]&n)?0:(15&this.regs[0])/30}getFrequency(){return 111860.8125/(1+(this.regs[1]|(15&this.regs[2])<<8))|0}getDutyRatio(){return 128&this.regs[0]?1:(1+(this.regs[0]>>4&7))/8}}class u extends l{constructor(){super(...arguments),this.acc=0,this.count=0}write(t,e){switch(super.write(t,e),t){case 2:this.count=0,0==(e&n)&&(this.acc=0)}}update(){0!=(this.regs[2]&n)?(this.acc+=63&this.regs[0],this.acc>=256&&(this.acc-=256,this.count=0),++this.count,this.count>=7&&(this.acc=0,this.count=0)):this.acc=0}getVolume(){return 0==(this.regs[2]&n)?0:Math.min((63&this.regs[0])*(6/255),1)}getFrequency(){return 1789773/14/((this.regs[1]|(15&this.regs[2])<<8)+1)|0}}class d extends i.Mapper{constructor(t,e){super(),this.options=t,this.ram=new Uint8Array(8192),this.chrRegs=new Uint8Array(8),this.prgCount=0,this.prgBank=0,this.ppuBankMode=0,this.mirrorMode=0,this.irqControl=0,this.irqLatch=0,this.irqCounter=0,this.channels=new Array(h.length),this.frequencyScaling=0,this.prgCount=t.prgSize>>13,this.options.prgBankCtrl.setPrgBank(0,0),this.options.prgBankCtrl.setPrgBank(1,1),this.setPrgBank(this.prgCount-2),this.options.bus.setWriteMemory(32768,40959,((t,e)=>{32768<=t&&t<=32771?this.setPrgBank((e&this.prgCount/2-1)<<1):36864<=t&&t<=36866?this.writeSound(0,3&t,e):36867===t&&(this.frequencyScaling=e)})),this.options.bus.setWriteMemory(49152,57343,((t,e)=>{49152<=t&&t<=49155&&this.options.prgBankCtrl.setPrgBank(2,e)}));const s=45056|e[3];this.options.bus.setWriteMemory(40960,49151,((t,e)=>{(61695&t)===s?(this.ppuBankMode=3&e,this.setChrBank(),this.mirrorMode=e>>2&3,this.options.ppu.setMirrorMode(a[this.mirrorMode])):40960<=t&&t<=40962?this.writeSound(1,3&t,e):45056<=t&&t<=45058&&this.writeSound(2,3&t,e)})),this.options.bus.setWriteMemory(53248,65535,((t,s)=>{if(53248<=t&&t<=61439){const i=t-53248>>10&4,r=15&t;if(r<4){const t=e[r]+i;this.chrRegs[t]=s,this.setChrBank()}}else switch(255&t){case 0:this.irqLatch=s;break;case 1:this.irqControl=s,0!=(2&this.irqControl)&&(this.irqCounter=this.irqLatch),this.options.cpu.clearIrqRequest(1);break;case 2:{const t=1&this.irqControl;this.irqControl=-3&this.irqControl|t<<1}}})),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,(t=>this.ram[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{this.ram[8191&t]=e})),this.setupAudio()}reset(){this.irqControl=0,this.irqLatch=this.irqCounter=0}save(){return{ram:r.default.convertUint8ArrayToBase64String(this.ram),chrRegs:r.default.convertUint8ArrayToBase64String(this.chrRegs),prgCount:this.prgCount,prgBank:this.prgBank,ppuBankMode:this.ppuBankMode,mirrorMode:this.mirrorMode,irqControl:this.irqControl,irqLatch:this.irqLatch,irqCounter:this.irqCounter}}load(t){this.ram=r.default.convertBase64StringToUint8Array(t.ram),this.chrRegs=r.default.convertBase64StringToUint8Array(t.chrRegs),this.prgCount=t.prgCount,this.ppuBankMode=t.ppuBankMode,this.mirrorMode=t.mirrorMode,this.irqControl=t.irqControl,this.irqLatch=t.irqLatch,this.irqCounter=t.irqCounter,this.setPrgBank(t.prgBank),this.setChrBank()}onHblank(t){if(0!=(2&this.irqControl)){let t=this.irqCounter;0==(4&this.irqControl)?t+=1:t+=185,t>=255&&(t=this.irqLatch,this.options.cpu.requestIrq(1)),this.irqCounter=t}241===t&&this.updateSound()}getExtraSoundChannelTypes(){return h}getSoundVolume(t){return 0!=(1&this.frequencyScaling)?0:this.channels[t].getVolume()}getSoundFrequency(t){let e=this.channels[t].getFrequency();return 0!=(4&this.frequencyScaling)?e*=256:0!=(2&this.frequencyScaling)&&(e*=16),e}getSoundDutyRatio(t){return this.channels[t].getDutyRatio()}setPrgBank(t){this.prgBank=t,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}setChrBank(){const t=o[this.ppuBankMode];for(let e=0;e<8;++e)this.options.ppu.setChrBankOffset(e,this.chrRegs[t[e]])}writeSound(t,e,s){this.channels[t].write(e,s)}setupAudio(){for(let t=0;t<this.channels.length;++t){let e;switch(h[t]){case 0:e=new c;break;case 2:e=new u;break;default:continue}this.channels[t]=e}}updateSound(){for(const t of this.channels)t.update()}}class p extends d{static create(t){return new p(t)}constructor(t){super(t,{0:0,1:1,2:2,3:3})}}e.Mapper024=p;class g extends d{static create(t){return new g(t)}constructor(t){super(t,{0:0,1:2,2:1,3:3})}}e.Mapper026=g},8316:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper032=void 0;const i=s(1197),r=[1,0];class n extends i.Mapper{constructor(t){super(),this.options=t;const e=(t.prgSize>>13)-1-1,s=[0,8192];let i=0;const n=()=>{let t,r,n;0===i?(t=s[0],r=s[1],n=e):(n=s[0],r=s[1],t=e),this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,r),this.options.prgBankCtrl.setPrgBank(2,n)},a=new Uint8Array(8192);a.fill(191),this.options.bus.setReadMemory(24576,32767,(t=>a[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{a[8191&t]=e})),this.options.bus.setWriteMemory(32768,40959,((t,e)=>{t<=36863?(s[0]=e,n()):(this.options.ppu.setMirrorMode(r[1&e]),i=e>>1&1,n())})),this.options.bus.setWriteMemory(40960,49151,((t,e)=>{t<=45055?(s[1]=e,n()):this.options.ppu.setChrBankOffset(7&t,e)}))}static create(t){return new n(t)}}e.Mapper032=n},9728:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper066=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t,this.prgPage=0,this.chrBank=0,this.options.bus.setWriteMemory(32768,65535,((t,e)=>{this.setPrgBank(e>>4&3),this.setChrBank(3&e)})),this.reset()}static create(t){return new r(t)}reset(){this.setPrgBank(0)}save(){return{prgPage:this.prgPage,chrBank:this.chrBank}}load(t){this.setPrgBank(t.prgPage),this.setChrBank(t.chrBank)}setPrgBank(t){this.prgPage=t,t<<=2,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1),this.options.prgBankCtrl.setPrgBank(2,t+2),this.options.prgBankCtrl.setPrgBank(3,t+3)}setChrBank(t){this.chrBank=t,this.options.ppu.setChrBank(t)}}e.Mapper066=r},9798:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper069=void 0;const i=s(1197),r=[1,0,2,3];class n extends i.Mapper{constructor(t){super(),this.options=t;let e=0;this.options.bus.setWriteMemory(32768,40959,((t,s)=>{e=15&s})),this.options.bus.setWriteMemory(40960,49151,((t,s)=>{switch(e){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.options.ppu.setChrBankOffset(e,s);break;case 9:case 10:case 11:this.options.prgBankCtrl.setPrgBank(e-9,s);break;case 12:this.options.ppu.setMirrorMode(r[3&s])}}));const s=new Uint8Array(8192);s.fill(191),this.options.bus.setReadMemory(24576,32767,(t=>s[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{s[8191&t]=e}))}static create(t){return new n(t)}}e.Mapper069=n},5925:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper073=void 0;const i=s(1197),r=s(5285);class n extends i.Mapper{constructor(t){super(),this.options=t,this.ram=new Uint8Array(8192),this.prgBank=0,this.irqEnable=!1,this.irqValue=this.irqCounter=-1;const e=t.prgSize>>14;this.options.prgBankCtrl.setPrgBank(0,0),this.options.prgBankCtrl.setPrgBank(1,1),this.setPrgBank(2*(e-1)),this.options.bus.setWriteMemory(61440,65535,((t,e)=>{this.setPrgBank(e<<1)})),this.options.bus.setWriteMemory(32768,40959,((t,e)=>{this.irqValue=t<36864?65520&this.irqValue|15&e:65295&this.irqValue|(15&e)<<4})),this.options.bus.setWriteMemory(40960,49151,((t,e)=>{this.irqValue=t<45056?61695&this.irqValue|(15&e)<<8:4095&this.irqValue|(15&e)<<12})),this.options.bus.setWriteMemory(49152,57343,((t,e)=>{t<53248&&(this.enableIrq(0!=(2&e)),this.irqCounter=this.irqValue)})),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,(t=>this.ram[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{this.ram[8191&t]=e}))}static create(t){return new n(t)}reset(){this.irqEnable=!1,this.irqValue=this.irqCounter=-1}save(){return{ram:r.default.convertUint8ArrayToBase64String(this.ram),prgBank:this.prgBank,irqEnable:this.irqEnable,irqValue:this.irqValue,irqCounter:this.irqCounter}}load(t){this.ram=r.default.convertBase64StringToUint8Array(t.ram),this.irqEnable=t.irqEnable,this.irqValue=t.irqValue,this.irqCounter=t.irqCounter,this.setPrgBank(t.prgBank)}onHblank(t){this.irqEnable&&this.irqCounter>0&&(this.irqCounter-=185,this.irqCounter<0&&(this.irqCounter=0,this.options.cpu.requestIrq(1)))}setPrgBank(t){this.prgBank=t,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}enableIrq(t){this.irqEnable=t}}e.Mapper073=n},546:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper075=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t;const e=t.prgSize>>13;for(let t=0;t<4;++t)this.options.prgBankCtrl.setPrgBank(t,e-1);const s=[0,0],i=(t,e)=>{s[t]=e;const i=t<<2,r=e<<2;for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(i+t,r+t)};this.options.bus.setWriteMemory(32768,40959,((t,e)=>{t<36864?this.options.prgBankCtrl.setPrgBank(0,e):(this.options.ppu.setMirrorMode(0==(1&e)?1:0),i(0,15&s[0]|(2&e)<<3),i(1,15&s[1]|(4&e)<<2))})),this.options.bus.setWriteMemory(40960,49151,((t,e)=>{t<45056&&this.options.prgBankCtrl.setPrgBank(1,e)})),this.options.bus.setWriteMemory(49152,57343,((t,e)=>{t<53248&&this.options.prgBankCtrl.setPrgBank(2,e)})),this.options.bus.setWriteMemory(57344,65535,((t,e)=>{const r=t>>12&1;i(r,16&s[r]|15&e)}));const r=new Uint8Array(8192);r.fill(191),this.options.bus.setReadMemory(24576,32767,(t=>r[8191&t])),this.options.bus.setWriteMemory(24576,32767,((t,e)=>{r[8191&t]=e}))}static create(t){return new r(t)}}e.Mapper075=r},2743:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper087=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(24576,32767,((t,e)=>{const s=(2&e)>>1|(1&e)<<1;this.options.ppu.setChrBank(s)}))}static create(t){return new r(t)}}e.Mapper087=r},6256:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mapper184=void 0;const i=s(1197);class r extends i.Mapper{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(24576,32767,((t,e)=>{const s=16+(e>>2&28),i=(7&e)<<2;for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(t+4,s+t);for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(t,i+t)}))}static create(t){return new r(t)}}e.Mapper184=r},9350:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.kMapperTable=void 0;const i=s(5226),r=s(6187),n=s(6600),a=s(647),o=s(8638),h=s(6778),l=s(7880),c=s(4616),u=s(3352),d=s(4463),p=s(8249),g=s(8316),f=s(9728),m=s(9798),b=s(5925),k=s(2743),y=s(546),C=s(6256);e.kMapperTable={0:i.Mapper000.create,1:r.Mapper001.create,2:n.Mapper002.create,3:a.Mapper003.create,4:o.Mapper004.create,7:h.Mapper007.create,10:l.Mapper010.create,16:c.Mapper016.create,19:u.Mapper019.create,23:d.Mapper023.create,24:p.Mapper024.create,25:d.Mapper025.create,26:p.Mapper026.create,32:g.Mapper032.create,66:f.Mapper066.create,69:m.Mapper069.create,73:b.Mapper073.create,75:y.Mapper075.create,87:k.Mapper087.create,88:o.Mapper088.create,93:n.Mapper093.create,95:o.Mapper095.create,118:o.Mapper118.create,184:C.Mapper184.create,185:a.Mapper185.create,206:o.Mapper004.create}},1267:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(8635),r=s(2245),n=s(6435),a=s(8453),o=s(5285),h=s(9350),l=s(2568);function c(t){return t*(3/341)|0}class u{constructor(){this.ram=new Uint8Array(2048),this.cycleCount=0,this.prgRom=new Uint8Array(0),this.prgBank=[],this.apuChannelCount=0,this.bus=new r.default,this.cpu=new n.default(this.bus),this.ppu=new a.default,this.apu=new i.Apu((()=>this.cpu.requestIrq(0))),this.vblankCallback=t=>{},this.breakPointCallback=()=>{},this.mapper=this.createMapper(0,-1),this.setMemoryMap()}static create(){return new u}getBus(){return this.bus}getCpu(){return this.cpu}getPpu(){return this.ppu}getCycleCount(){return this.cycleCount}setVblankCallback(t){this.vblankCallback=t}setBreakPointCallback(t){this.breakPointCallback=t}setRomData(t){if(!function(t){return 78===t[0]&&69===t[1]&&83===t[2]&&26===t[3]}(t))return"Invalid format";const e=function(t){return t[6]>>4&15|240&t[7]}(t);if(!(e in h.kMapperTable))return`Mapper ${e} not supported`;this.prgRom=function(t){const e=16384*t[4];return t.slice(16,16+e)}(t),this.ppu.setChrData(function(t){const e=16+16384*t[4],s=8192*t[5];return t.slice(e,e+s)}(t)),this.ppu.setMirrorMode(0==(1&t[6])?0:1),this.cpu.deleteAllBreakPoints(),this.setMemoryMap();const s=l(t);return this.mapper=this.createMapper(e,this.prgRom.length,s),!0}setMapper(t){this.mapper=t}save(){return{cpu:this.cpu.save(),ppu:this.ppu.save(),apu:this.apu.save(),mapper:null!=this.mapper?this.mapper.save():null,ram:o.default.convertUint8ArrayToBase64String(this.ram)}}load(t){this.cpu.load(t.cpu),this.ppu.load(t.ppu),this.apu.load(t.apu),this.mapper.load(t.mapper),this.ram=o.default.convertBase64StringToUint8Array(t.ram)}reset(){this.cpu.reset(),this.ppu.reset(),this.apu.reset(),this.cycleCount=0,null!=this.mapper&&this.mapper.reset()}setPadStatus(t,e){this.apu.setPadStatus(t,e)}runMilliseconds(t){const e=1789.773*t|0;try{let t=e;for(;t>0;)if(t-=this.step(t),this.cpu.isPaused())return this.breakPointCallback(),0;return-e}catch(t){throw this.cpu.pause(!0),t}}step(t){const e=this.cpu.step();return this.cycleCount=this.tryHblankEvent(this.cycleCount,e,t),e}getSoundChannelTypes(){const t=this.apu.getChannelTypes(),e=this.mapper.getExtraSoundChannelTypes();return this.apuChannelCount=t.length,t.concat(e)}getSoundVolume(t){return t<this.apuChannelCount?this.apu.getVolume(t):this.mapper.getSoundVolume(t-this.apuChannelCount)}getSoundFrequency(t){return t<this.apuChannelCount?this.apu.getFrequency(t):this.mapper.getSoundFrequency(t-this.apuChannelCount)}getSoundDutyRatio(t){return t<this.apuChannelCount?this.apu.getDutyRatio(t):this.mapper.getSoundDutyRatio(t-this.apuChannelCount)}render(t){this.ppu.render(t)}setPrgBank(t,e){this.prgBank[t]=e<<13}createMapper(t,e,s){return(0,h.kMapperTable[t])({bus:this.bus,cpu:this.cpu,ppu:this.ppu,prgBankCtrl:this,prgSize:e,romHash:s})}readFromApu(t){return this.apu.read(t)}writeToApu(t,e){switch(t){case 16404:0<=e&&e<=31?this.ppu.copyWithDma(this.ram,e<<8):console.error(`OAMDMA not implemented except for RAM: ${o.default.hex(e,2)}`);break;default:this.apu.write(t,e)}}setMemoryMap(){const t=this.bus;t.clearMemoryMap(),t.setReadMemory(8192,16383,(t=>{const e=7&t;return this.ppu.read(e)})),t.setWriteMemory(8192,16383,((t,e)=>{const s=7&t;this.ppu.write(s,e)})),t.setReadMemory(16384,24575,(t=>this.readFromApu(t))),t.setWriteMemory(16384,24575,((t,e)=>this.writeToApu(t,e)));const e=this.prgRom.length-1|0;this.prgBank=[0,8192,-16384&e,-8192&e],t.setReadMemory(32768,65535,(t=>{const s=(t|=0)-32768>>13,i=8191&t|0;return 0|this.prgRom[(0|this.prgBank[s])+i&e]})),t.setReadMemory(0,8191,(t=>this.ram[2047&t])),t.setWriteMemory(0,8191,((t,e)=>{this.ram[2047&t]=e}))}tryHblankEvent(t,e,s){let i=t+e;const r=c(t);let n=c(i);if(n>r){switch(262===n&&(i-=29780,n=0),this.ppu.setHcount(n),this.apu.onHblank(n),n){case 240:this.ppu.setVBlank(),this.vblankCallback(s/29780|0);break;case 241:this.interruptVBlank();break;case 261:this.ppu.clearVBlank()}this.mapper.onHblank(n)}return i}interruptVBlank(){this.ppu.interruptEnable()&&this.interruptNmi()}interruptNmi(){this.cpu.nmi()}}e.default=u},7162:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.kFlipXBits=e.kStaggered=e.kPaletColors=void 0,e.kPaletColors=Uint32Array.from([8158332,252,188,4466876,9699460,11010080,11014144,8918016,5255168,30720,26624,22528,16472,0,0,0,12369084,30968,22776,6833404,14155980,14942296,16267264,14965776,11303936,47104,43008,43076,34952,0,0,0,16316664,3980540,6850812,9992440,16283896,16275608,16283736,16556100,16300032,12122136,5822548,5830808,59608,7895160,0,0,16579836,10806524,12105976,14203128,16300280,16295104,15782064,16572584,16308344,14219384,12122296,12122328,64764,16308472,0,0]),e.kStaggered=(()=>{const t=new Uint16Array(256);for(let e=0;e<256;++e){let s=0;for(let t=0;t<8;++t)s<<=2,0!=(e&1<<7-t)&&(s|=1);t[e]=s}return t})(),e.kFlipXBits=(()=>{const t=new Uint8Array(256);for(let e=0;e<256;++e){let s=0;for(let t=0;t<8;++t)s<<=1,0!=(e&1<<t)&&(s|=1);t[e]=s}return t})()},2675:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HStatusMgr=e.HStatus=e.HEvents=void 0;const i=s(9763);class r{constructor(){this.count=0,this.events=new Array}clear(){this.count=0}add(t,e,s,i=-1){const r=this.count;for(let n=r;--n>=0;){const a=this.events[n];if(a.hcount!==t)break;if(a.type===e&&a.index===i){for(let t=n;++t<r;)this.events[t-1]=this.events[t];return this.events[r-1]=a,void(a.value=s)}}if(r>=this.events.length){const r={type:e,value:s,index:i,hcount:t};this.events.push(r)}else{const n=this.events[r];n.type=e,n.value=s,n.index=i,n.hcount=t}++this.count}}e.HEvents=class{constructor(){this.renderBuf=new r,this.nextBuf=new r}clear(){this.renderBuf.clear(),this.nextBuf.clear()}swap(){this.nextBuf.add(i.Const.HEIGHT,0,0);const t=this.renderBuf;this.renderBuf=this.nextBuf,this.nextBuf=t,this.nextBuf.clear(),this.nextBuf.add(0,0,0)}getCount(){return this.renderBuf.count-1}getEvent(t){return this.renderBuf.events[t]}getLastHcount(){const t=this.nextBuf.count;return t<=0?-1:this.nextBuf.events[t-1].hcount}add(t,e,s,i=-1){this.nextBuf.add(t,e,s,i)}};class n{constructor(){this.ppuCtrl=0,this.ppuMask=0,this.chrBankOffset=new Array(8),this.mirrorModeBit=68,this.scrollCurr=0,this.scrollFineX=0,this.reset()}reset(){this.ppuCtrl=0,this.ppuMask=0,this.scrollCurr=0,this.scrollFineX=0;for(let t=0;t<8;++t)this.chrBankOffset[t]=t<<10}copy(t){this.ppuCtrl=t.ppuCtrl,this.ppuMask=t.ppuMask,this.mirrorModeBit=t.mirrorModeBit;for(let e=0;e<8;++e)this.chrBankOffset[e]=t.chrBankOffset[e];this.scrollCurr=t.scrollCurr,this.scrollFineX=t.scrollFineX}set(t,e,s){switch(t){case 0:break;case 1:if(this.ppuCtrl===e)return!1;this.ppuCtrl=e;break;case 2:if(this.ppuMask===e)return!1;this.ppuMask=e;break;case 3:if(this.chrBankOffset[s]===e)return!1;this.chrBankOffset[s]=e;break;case 4:if(this.mirrorModeBit===e)return!1;this.mirrorModeBit=e;break;case 5:if(this.scrollCurr===e)return!1;this.scrollCurr=e;break;case 6:if(this.scrollFineX===e)return!1;this.scrollFineX=e;break;default:return console.error(`ERROR: type=${t}`),!1}return!0}}e.HStatus=n,e.HStatusMgr=class{constructor(){this.current=new n,this.lastFrame=new n,this.save=new n}reset(){this.current.reset(),this.lastFrame.reset(),this.save.reset()}swap(){const t=this.lastFrame;this.lastFrame=this.save,this.save=t,this.save.copy(this.current)}}},8453:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getBgPat=e.getBgPatternTableAddress=e.getNameTable=void 0;const i=s(9763),r=s(7162),n=s(2675),a=s(5285),o=16128,h=Uint8Array.from([80,68,0,85,5]),l=Uint8Array.from([9,1,0,1,0,2,2,13,8,16,8,36,0,0,4,44,9,1,52,3,0,4,0,20,8,58,0,2,0,32,44,8]),c=Uint8Array.from([128,255]);function u(t,e,s,i){return 8192+(i<<10-(((e>>5&1)+((s/30&1)<<1)^t)<<1)&3072)|0}function d(t){return(16&t)<<8}function p(t,e,s,i){const n=e+s,a=i[n>>10&7]+(1023&n);return r.kStaggered[t[a]]|r.kStaggered[t[a+8]]<<1}function g(t,e){return 12288<=(t&=16383)&&t<16128&&(t-=4096),8192<=t&&t<12288?62463&t|e<<10-((t>>10&3)<<1)&3072:(o<=t&&t<=16383&&16144==(65523&(t&=65311))&&(t&=65519),t)}function f(t,e){return t+(0!=(4&e)?32:1)&16383}function m(t,e,s,i,n){const a=e+(7&s)+((8&s)<<1),o=n[a>>10&7]+(1023&a);let h=t[o+8],l=t[o];return i&&(h=r.kFlipXBits[h],l=r.kFlipXBits[l]),r.kStaggered[l]|r.kStaggered[h]<<1}function b(t,e,s,r){const n=i.Const.WIDTH;for(let i=e;i<s;++i){const e=i*n;for(let s=0;s<r;++s)t[e+s]=0}}e.getNameTable=u,e.getBgPatternTableAddress=d,e.getBgPat=p,e.default=class{constructor(){this.suppressSpriteFlicker=!0,this.chrData=new Uint8Array(0),this.regs=new Uint8Array(8),this.oam=new Uint8Array(256),this.mirrorMode=1,this.hcount=0,this.latch=0,this.ppuAddr=0,this.bufferedValue=0,this.hevents=new n.HEvents,this.hstatusMgr=new n.HStatusMgr,this.offscreen=new Uint8Array(i.Const.WIDTH*i.Const.HEIGHT);const t=new ArrayBuffer(16384);this.vram=new Uint8Array(t),this.palet=new Uint8Array(t,o),this.reset()}reset(){this.regs.fill(0),this.vram.fill(0),this.oam.fill(0),this.hcount=0,this.ppuAddr=0,this.latch=0,this.bufferedValue=0,this.hevents.clear(),this.hstatusMgr.reset(),this.offscreen.fill(0);for(let t=0;t<32;++t)this.palet[t]=l[t]}save(){const t={regs:a.default.convertUint8ArrayToBase64String(this.regs),oam:a.default.convertUint8ArrayToBase64String(this.oam),mirrorMode:this.mirrorMode};return this.isChrRam()?t.vram=a.default.convertUint8ArrayToBase64String(this.vram):t.vramHigh=a.default.convertUint8ArrayToBase64String(this.vram.subarray(8192)),t}load(t){const e=this.isChrRam();if(this.regs=a.default.convertBase64StringToUint8Array(t.regs),this.oam=a.default.convertBase64StringToUint8Array(t.oam),this.mirrorMode=t.mirrorMode,e){const e=a.default.convertBase64StringToUint8Array(t.vram);for(let t=0;t<e.length;++t)this.vram[t]=e[t]}else{const e=a.default.convertBase64StringToUint8Array(t.vramHigh);for(let t=0;t<e.length;++t)this.vram[t+8192]=e[t]}this.hstatusMgr.current.set(1,this.regs[0],-1),this.hstatusMgr.current.set(2,this.regs[1],-1),this.hstatusMgr.current.set(4,h[this.mirrorMode],-1)}setChrData(t){const e=!(t&&t.length>0);this.chrData=e?this.vram:t}setChrBank(t){const e=t<<3;for(let t=0;t<8;++t)this.setChrBankOffset(t,e+t)}setChrBankOffset(t,e){const s=e<<10&this.chrData.length-1;this.incScrollCounter(),this.addHevent(3,s,t)}getMirrorMode(){return this.mirrorMode}setMirrorMode(t){this.mirrorMode=t;const e=h[t];this.incScrollCounter(),this.addHevent(4,e)}read(t){let e=this.regs[t];switch(t){case 2:this.regs[2]&=-129,this.latch=0;break;case 4:e=this.oam[this.regs[3]];break;case 7:{const t=this.hstatusMgr.current.scrollCurr,s=g(t,this.hstatusMgr.current.mirrorModeBit);o<=s&&s<=16383?(e=this.readPpuDirect(s),this.bufferedValue=this.readPpuDirect(g(t-4096,this.hstatusMgr.current.mirrorModeBit))):(e=this.bufferedValue,this.bufferedValue=this.readPpuDirect(s)),this.addHevent(5,f(t,this.regs[0]))}}return e}write(t,e){switch(2===t&&(e&=-225),this.regs[t]=e,t){case 0:this.incScrollCounter(),this.addHevent(1,this.regs[0]),this.ppuAddr=-3073&this.ppuAddr|(3&e)<<10,this.updateCoarseX();break;case 1:this.incScrollCounter(),this.addHevent(2,this.regs[1]);break;case 4:{const t=this.regs[3];this.oam[t]=e,this.regs[3]=t+1&255}break;case 5:this.incScrollCounter(),0===this.latch?(this.ppuAddr=-32&this.ppuAddr|e>>3,this.addHevent(6,7&e),this.updateCoarseX()):this.ppuAddr=-29665&this.ppuAddr|(248&e)<<2|(7&e)<<12,this.latch=1-this.latch;break;case 6:0===this.latch?this.ppuAddr=-32513&this.ppuAddr|(63&e)<<8:(this.ppuAddr=-256&this.ppuAddr|e,this.addHevent(5,this.ppuAddr)),this.latch=1-this.latch;break;case 7:{const t=this.hstatusMgr.current.scrollCurr,s=g(t,this.hstatusMgr.current.mirrorModeBit);this.vram[s]=e,this.addHevent(5,f(t,this.regs[0]))}}}copyWithDma(t,e){const s=this.oam;let i=this.regs[3];for(let r=0;r<256;++r)s[i]=t[e+r],i=i+1&255}setVBlank(){this.regs[2]=128|this.regs[2],this.hevents.swap(),this.hstatusMgr.swap()}clearVBlank(){this.regs[2]&=-225,0!=(24&this.hstatusMgr.current.ppuMask)&&this.addHevent(5,this.ppuAddr)}interruptEnable(){return 0!=(128&this.regs[0])}setHcount(t){this.hcount=t,this.checkSprite0Hit(t)}render(t){this.renderOffscreen(this.offscreen);const e=0!=(1&this.regs[1]);!function(t,e,s,n){const a=i.Const.WIDTH*i.Const.HEIGHT;let o=0;const h=s?32:63;for(let s=0;s<a;++s){const i=n[31&t[s]]&h,a=r.kPaletColors[i];e[o+0]=a>>16,e[o+1]=a>>8&255,e[o+2]=255&a,o+=4}}(this.offscreen,t,e,this.palet)}writePpuDirect(t,e){if(t>=8192)this.vram[t]=e;else{const s=this.hstatusMgr.current.chrBankOffset[t>>10&7];this.chrData[(1023&t)+s]=e}}getPaletTable(){return this.palet}getRegs(){return this.regs}getVram(){return this.vram}getChrData(){return this.chrData}getHStatusMgr(){return this.hstatusMgr}isChrRam(){return this.chrData===this.vram}renderOffscreen(t){const e=this.hstatusMgr.lastFrame,s=this.hevents.getCount();let r=0;for(let n=0;n<s;++n){const s=this.hevents.getEvent(n);e.set(s.type,s.value,s.index);const a=s.hcount,o=this.hevents.getEvent(n+1).hcount;if(!(a>=o)){if(0==(8&e.ppuMask))b(t,a,o,i.Const.WIDTH);else{const s=(3072&e.scrollCurr)>>10,i=d(e.ppuCtrl);let r=0;0==(2&e.ppuMask)&&(r=8,b(t,a,o,r));const n=e.scrollFineX|(31&e.scrollCurr)<<3,h=(28672&e.scrollCurr)>>12|(992&e.scrollCurr)>>2;this.renderBg(t,n,h,s,a,o,r,e.chrBankOffset,e.mirrorModeBit,i)}if(0!=(16&e.ppuMask)){0==(32&e.ppuCtrl)&&(r=(8&e.ppuCtrl)<<9);const s=4&e.ppuMask?0:8;this.renderSprite(t,a,o,s,e.chrBankOffset,r)}}}}renderBg(t,e,s,r,n,a,o,h,l,c){e|=0,s|=0,n|=0,a|=0,o|=0,l|=0;const d=0|i.Const.WIDTH,g=this.vram;s>=240&&(s=s-256|0);const f=7&e,m=e>>3;for(let e=n;e<a;++e){const a=e-n+s,b=(60+(a>>3))%60,k=b%30;for(let s=0;s<i.Const.WIDTH/8+1;++s){const n=s+m&63,y=31&n,C=0|u(r,n,b,l),w=(g[C+y+(k<<5)]<<4)+c,v=(2&y)+((2&k)<<1),B=(g[(y>>2)+(k<<1&248)+(C+960|0)]>>v&3)<<2|0,M=8*s-f|0,x=0|Math.max(o-M,0),S=0|Math.min(i.Const.WIDTH-M,8),P=p(this.chrData,w,7&a,h);for(let s=x;s<S;++s){let i=P>>14-(s<<1)&3|0;0!==i&&(i|=B),t[e*d+(s+M|0)]=i}}}}isSprite8x16(){return 0!=(32&this.regs[0])}renderSprite(t,e,s,r,n,a){const o=i.Const.WIDTH,h=this.oam,l=this.isSprite8x16(),u=l?16:8;for(let d=e;d<s;++d){let e=0;for(let s=0;s<64;++s){const p=h[4*s+0]+1;if(d<p||d>=p+u)continue;const g=h[4*s+1],f=h[4*s+2],b=0!=(128&f),k=0!=(64&f),y=h[4*s+3],C=c[f>>5&1],w=l?16*(254&g)+((1&g)<<12):16*g+a,v=(3&f)<<2|144,B=d-p,M=Math.max(r-y,0),x=Math.min(i.Const.WIDTH-y,8),S=b?u-1-B:B,P=m(this.chrData,w,S,k,n);for(let e=M;e<x;++e){const s=P>>(7-e<<1)&3;if(0===s)continue;const i=(p+B)*o+(y+e);0==(t[i]&C)?t[i]=v+s:t[i]|=128}if(++e>=8&&!this.suppressSpriteFlicker){this.regs[2]|=32;break}}}}checkSprite0Hit(t){if(0!=(64&this.regs[2])||24!=(24&this.regs[1]))return;const e=this.oam[0]+1;if(t<e||t>=e+16)return;if(this.oam[3]>=255)return;const s=this.getNonEmptySprite0Line();s<0||t!==e+s||(this.regs[2]|=64)}getNonEmptySprite0Line(){const t=this.oam,e=this.getSpritePatternTableAddress(),s=this.isSprite8x16(),i=s?16:8,r=t[1],n=0!=(128&t[2]),a=s?16*(254&r)+((1&r)<<12):16*r+e;for(let t=0;t<i;++t){const e=n?i-1-t:t;if(0!==m(this.chrData,a,e,!1,this.hstatusMgr.current.chrBankOffset))return t}return-1}getSpritePatternTableAddress(){return 0==(32&this.regs[0])?(8&this.regs[0])<<9:0}addHevent(t,e,s=-1){if(!this.hstatusMgr.current.set(t,e,s))return;let r=this.hcount+1;r>=i.Const.HEIGHT&&(r=0),this.hevents.add(r,t,e,s)}incScrollCounter(){if(!this.visible())return;const t=this.hevents.getLastHcount();if(t<0)return;const e=this.hcount+1-t;e<=0||this.addHevent(5,function(t,e){let s=(992&t)>>2|t>>12&7;s>=240&&(s-=256);const i=240*(t>>11&1)+s+e,r=i%240;return-31713&t|(248&r)<<2|(7&r)<<12|(i/240&1)<<11}(this.hstatusMgr.current.scrollCurr,e))}visible(){return this.hcount<i.Const.HEIGHT&&0!=(24&this.hstatusMgr.current.ppuMask)}updateCoarseX(){if(this.visible()){const t=-1056&this.hstatusMgr.current.scrollCurr|1055&this.ppuAddr;this.addHevent(5,t)}}readPpuDirect(t){if(t>=8192)return this.vram[t];{const e=this.hstatusMgr.current.chrBankOffset[t>>10&7];return this.chrData[(1023&t)+e]}}}},8907:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});class s extends class{constructor(t){this.gainNode=t.createGain(),this.gainNode.gain.setValueAtTime(0,t.currentTime)}destroy(){null!=this.gainNode&&this.gainNode.disconnect()}start(){}setVolume(t,e){this.gainNode.gain.setValueAtTime(t,e.currentTime)}setFrequency(t){}setDutyRatio(t){}}{constructor(t,e){super(t),this.oscillator=t.createOscillator(),this.setupOscillator(this.oscillator,t,e)}destroy(){super.destroy(),null!=this.oscillator&&this.oscillator.disconnect()}start(){this.oscillator.start()}setFrequency(t){const e=this.gainNode.context.currentTime;this.oscillator.frequency.setValueAtTime(t,e)}}class i extends s{setupOscillator(t,e,s){t.type="triangle",t.connect(this.gainNode),this.gainNode.connect(s)}}class r extends s{setupOscillator(t,e,s){t.type="sawtooth",t.connect(this.gainNode),this.gainNode.connect(s)}}class n extends s{setupOscillator(t,e,s){const i=1024,r=new Float32Array(i),n=new Float32Array(i);r[0]=n[0]=0;for(let t=1;t<i;++t){const e=Math.random()*(2*Math.PI);r[t]=Math.cos(e),n[t]=Math.sin(e)}const a=e.createPeriodicWave(r,n);t.setPeriodicWave(a),t.connect(this.gainNode),this.gainNode.connect(s)}}class a extends s{constructor(){super(...arguments),this.frequency=1,this.duty=.5}destroy(){super.destroy(),null!=this.delay&&this.delay.disconnect()}setFrequency(t){this.frequency!==t&&(this.frequency=t,super.setFrequency(t),this.updateDelay())}setDutyRatio(t){this.duty!==t&&(this.duty=t,this.updateDelay())}setupOscillator(t,e,s){t.type="sawtooth";const i=e.createGain();i.gain.value=-1,t.connect(i),i.connect(this.gainNode);const r=e.createDelay();t.connect(r),r.connect(this.gainNode),this.delay=r,this.gainNode.connect(s)}updateDelay(){const t=this.delay.context.currentTime;this.delay.delayTime.setValueAtTime((1-this.duty)/this.frequency,t)}}class o extends s{setupOscillator(t,e,s){}}class h{constructor(){this.channels=new Array,h.checkSetUpCalled()}static setUp(t){h.initialized||null!=t&&(h.audioContextClass=t,h.initialized=!0)}static enableAudio(){if(null!=h.context)return;const t=h.audioContextClass;null!=t&&(h.context=new t,h.masterGainNode=h.context.createGain(),h.masterGainNode.gain.setValueAtTime(h.masterVolume,h.context.currentTime),h.masterGainNode.connect(h.context.destination),h.initialized=!0)}static setMasterVolume(t){h.checkSetUpCalled(),h.masterVolume=t;const e=h.context;e&&h.masterGainNode.gain.setValueAtTime(t,e.currentTime)}static createAnalyser(){const t=h.context;return null==t?null:(null==h.analyserNode&&(h.analyserNode=t.createAnalyser(),h.masterGainNode.disconnect(),h.masterGainNode.connect(h.analyserNode),h.analyserNode.connect(t.destination)),h.analyserNode)}static checkSetUpCalled(){h.initialized||console.error("Audio.setUp must be called!")}release(){this.releaseAllChannels()}releaseAllChannels(){if(null!=this.channels){for(const t of this.channels)t.destroy();this.channels.length=0}}addChannel(t){const e=h.context;if(null==e)return;const s=function(t,e,s){switch(s){case 0:return new a(t,e);case 1:return new i(t,e);case 3:return new n(t,e);case 2:return new r(t,e);case 4:return new o(t,e)}}(e,h.masterGainNode,t);s.start(),this.channels.push(s)}getChannelCount(){return this.channels.length}setChannelFrequency(t,e){null!=h.context&&this.channels[t].setFrequency(e)}setChannelVolume(t,e){null!=h.context&&this.channels[t].setVolume(e,h.context)}setChannelDutyRatio(t,e){null!=h.context&&this.channels[t].setDutyRatio(e)}}e.default=h,h.initialized=!1,h.masterVolume=1},3104:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{static clearCanvas(t){const e=t.getContext("2d");null!=e&&(e.strokeStyle="",e.fillStyle="rgb(64,64,64)",e.fillRect(0,0,t.width,t.height))}static removeAllChildren(t){for(const e of t.childNodes)t.removeChild(e)}static setStyles(t,e){Object.assign(t.style,e)}static loadFile(t){return new Promise(((e,s)=>{const i=new FileReader;i.onload=function(t){const i=t.target;i.result?e(new Uint8Array(i.result)):s()},i.onerror=function(t){s(i.error)},i.readAsArrayBuffer(t)}))}static handleFileDrop(t,e){t.addEventListener("dragover",(function(t){return t.dataTransfer&&(t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"),!1}),!1),t.addEventListener("drop",(function(t){if(t.dataTransfer){t.stopPropagation(),t.preventDefault();const s=t.dataTransfer.files;s.length>0&&e(s,t.pageX,t.pageY)}return!1}),!1)}static getCanvasContext2d(t){const e=t.getContext("2d");if(null==e)throw new Error("2d context not supported or canvas already initialized");return e}static timeout(t){return new Promise((e=>setTimeout(e,t)))}static download(t,e){const s=window.URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.setAttribute("download",e),i.click()}static setMouseDragListener(t,e,s){let i=null,r=null;if("object"==typeof t){const n=t;t=n.move,e=n.up,i=n.leave,s=n.useCapture,r=null==i?null:n.leaveTarget||document}const n=()=>{document.removeEventListener("mousemove",t,s),document.removeEventListener("mouseup",a,s),o&&r&&r.removeEventListener("mouseleave",o,s)},a=t=>{e&&e(t),n()},o=null==i?null:t=>{i&&i(t)&&n()};document.addEventListener("mousemove",t,s),document.addEventListener("mouseup",a,s),o&&r&&r.addEventListener("mouseleave",o,s)}static getMousePosIn(t,e){const s=e.getBoundingClientRect(),i=document.body.scrollLeft,r=document.body.scrollTop;return[t.pageX-s.left-i,t.pageY-s.top-r]}}},3839:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(8989),r=["A","B","SELECT","START","U","D","L","R"];class n{static setUp(){n.initialized||(n.loadSetting(),n.initialized=!0)}static isSupported(){return"Gamepad"in window}static getState(t){if(!n.isSupported())return 0;const e=navigator.getGamepads();if(t>=e.length)return 0;const s=e[t];if(!s)return 0;const i=n.AXIS_THRESHOLD;let r=0;return n.padSettings.forEach(((t,e)=>{switch(t.type){case 0:(s.axes[t.index]||0)*t.direction>=i&&(r|=1<<e);break;case 1:{const i=s.buttons[t.index];i&&i.pressed&&(r|=1<<e)}}})),r}static setButton(t,e){n.padSettings[t].type=1,n.padSettings[t].index=e,n.padSettings[t].direction=1,n.saveSetting()}static setAxis(t,e,s){n.padSettings[t].type=0,n.padSettings[t].index=e,n.padSettings[t].direction=s,n.saveSetting()}static saveSetting(){const t={};n.padSettings.forEach(((e,s)=>{const i=r[s];switch(e.type){default:break;case 1:t[i]={button:e.index};break;case 0:t[i]={axis:e.index,direction:e.direction}}})),i.default.putObject("pad0",t)}static loadSetting(){const t=i.default.getObject("pad0",{});"object"==typeof t&&Object.keys(t).forEach((e=>{const s=r.indexOf(e.toUpperCase());if(s<0)return;const i=t[e];"button"in i?n.setButton(s,i.button):"axis"in i&&"direction"in i&&n.setAxis(s,i.axis,parseInt(i.direction,10))}))}}e.default=n,n.AXIS_THRESHOLD=.5,n.initialized=!1,n.padSettings=[{type:1,index:0},{type:1,index:1},{type:1,index:2},{type:1,index:3},{type:0,index:1,direction:-1},{type:0,index:1,direction:1},{type:0,index:0,direction:-1},{type:0,index:0,direction:1}]},2772:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{constructor(){this.pressingKeys={},this.lastPressing=null}onKeyDown(t){this.pressingKeys[t.code]=!0,this.lastPressing=t.code}onKeyUp(t){this.pressingKeys[t.code]=!1,this.lastPressing===t.code&&(this.lastPressing=null)}clear(){Object.keys(this.pressingKeys).forEach((t=>this.pressingKeys[t]=!1))}getKeyPressing(t){return!0===this.pressingKeys[t]}getLastPressing(){return this.lastPressing}}},9746:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});class s extends Storage{constructor(){super(),this.storage={}}setItem(t,e){this.storage[t]=String(e)}getItem(t){const e=this.storage[t];return void 0===e?null:e}removeItem(t){delete this.storage[t]}get length(){return Object.keys(this.storage).length}key(t){return Object.keys(this.storage)[t]}}e.default=s},1907:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=[[{key:"KeyX",bit:1},{key:"KeyZ",bit:2},{key:"Space",bit:4},{key:"Enter",bit:8},{key:"ArrowUp",bit:16},{key:"ArrowDown",bit:32},{key:"ArrowLeft",bit:64},{key:"ArrowRight",bit:128}],[{key:"KeyW",bit:1},{key:"KeyQ",bit:2},{key:"KeyO",bit:4},{key:"KeyP",bit:8},{key:"KeyI",bit:16},{key:"KeyK",bit:32},{key:"KeyJ",bit:64},{key:"KeyL",bit:128}]];e.default=class{constructor(){this.status=new Uint8Array(2)}static getMapping(t){return s[t]}getStatus(t){return this.status[t]}clearAll(){this.status.fill(0)}update(t){for(let e=0;e<2;++e){const i=s[e];let r=0;for(let e=0;e<i.length;++e)t.getKeyPressing(i[e].key)&&(r|=i[e].bit);this.status[e]=r}}}},8402:()=>{"use strict";"fill"in Array.prototype||(Array.prototype.fill=function(t,e=0,s){void 0===s&&(s=this.length);for(let i=e;i<s;++i)this[i]=t;return this}),"fill"in Uint8Array.prototype||(Uint8Array.prototype.fill=function(t,e=0,s){void 0===s&&(s=this.length);for(let i=e;i<s;++i)this[i]=t;return this}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(t,e){void 0===e&&(e=this.length);const s=new Uint8Array(e-t);for(let e=0;e<s.length;++e)s[e]=this[e+t];return s})},3576:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Subject=void 0,e.Subject=class{constructor(){this.subscribers=new Array,this.anyRemoved=!1,this.nestCount=0}subscribe(t){return this.subscribers.push(t),{unsubscribe:()=>{const e=this.subscribers.indexOf(t);-1!==e&&(this.subscribers[e]=null,this.anyRemoved=!0)}}}next(t,e){++this.nestCount;for(const s of this.subscribers)null!=s&&s(t,e);--this.nestCount,0===this.nestCount&&this.anyRemoved&&(function(t){let e=0;for(let s=0;s<t.length;++s)null!=t[s]&&(t[e++]=t[s]);t.length=e}(this.subscribers),this.anyRemoved=!1)}}},1357:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EpxScaler=e.ScanlineScaler=e.NearestNeighborScaler=e.Scaler=void 0;const i=s(3104),r=256,n=240;function a(t,e){const s=document.createElement("canvas");return s.className="full-size",s.width=t,s.height=e,i.default.setStyles(s,{display:"block"}),i.default.clearCanvas(s),s}function o(t){for(let e=0,s=t.width*t.height*4;e<s;++e)t.data[4*e+0]=0,t.data[4*e+1]=0,t.data[4*e+2]=0,t.data[4*e+3]=255}class h{getCanvas(){return this.canvas}reset(){i.default.clearCanvas(this.canvas)}}e.Scaler=h,e.NearestNeighborScaler=class extends h{constructor(){super(),this.canvas=a(r,n),this.context=i.default.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),o(this.imageData),this.canvas.classList.add("pixelated")}render(t){t.render(this.imageData.data),this.context.putImageData(this.imageData,0,0)}},e.ScanlineScaler=class extends h{constructor(){super(),this.canvas=a(r,480),this.context=i.default.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),o(this.imageData),this.orgImageData=new ImageData(r,n),o(this.orgImageData)}render(t){t.render(this.orgImageData.data);const e=this.orgImageData.data,s=this.imageData.data;for(let t=0;t<n;++t){let i=1024*t,n=2*i;for(let t=0;t<r;++t)s[n+0]=e[i+0],s[n+1]=e[i+1],s[n+2]=e[i+2],i+=4,n+=4;i=1024*t;for(let t=0;t<r;++t)s[n+0]=e[i+0]>>1,s[n+1]=e[i+1]>>1,s[n+2]=e[i+2]>>1,i+=4,n+=4}this.context.putImageData(this.imageData,0,0)}},e.EpxScaler=class extends h{constructor(){super(),this.canvas=a(512,480),this.context=i.default.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),o(this.imageData),this.orgImageData=new ImageData(r,n),o(this.orgImageData)}render(t){t.render(this.orgImageData.data);const e=this.orgImageData.data,s=this.imageData.data;for(let t=0;t<n;++t){const i=0|Math.max(t-1,0),n=0|Math.min(t+1,239);for(let a=0;a<r;++a){const o=0|Math.max(a-1,0),h=0|Math.min(a+1,255),l=4*(t*r+a),c=4*(i*r+a),u=4*(n*r+a),d=4*(t*r+o),p=4*(t*r+h),g=e[l+0]<<16|e[l+1]<<8|e[l+2],f=e[c+0]<<16|e[c+1]<<8|e[c+2],m=e[u+0]<<16|e[u+1]<<8|e[u+2],b=e[d+0]<<16|e[d+1]<<8|e[d+2],k=e[p+0]<<16|e[p+1]<<8|e[p+2];let y=g,C=g,w=g,v=g;b===f&&b!==m&&f!==k&&(y=f),f===k&&f!==b&&k!==m&&(C=k),m===b&&m!==k&&b!==f&&(w=b),k===m&&k!==f&&m!==b&&(v=m);const B=8*(512*t+a);s[B+0]=y>>16,s[B+1]=y>>8&255,s[B+2]=255&y,s[B+4]=C>>16,s[B+5]=C>>8&255,s[B+6]=255&C,s[B+2048]=w>>16,s[B+2049]=w>>8&255,s[B+2050]=255&w,s[B+2052]=v>>16,s[B+2053]=v>>8&255,s[B+2054]=255&v}}this.context.putImageData(this.imageData,0,0)}}},8989:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(9746);let r=window.localStorage,n="";if(null==r){try{"localStorage"in window&&null!=window.localStorage&&(r=window.localStorage)}catch(t){}null==r&&(r=new i.default)}function a(t){return`${n}${t}`}e.default=class{static setKeyPrefix(t){n=t}static hasKey(t){const e=a(t);return null!=r.getItem(e)}static get(t,e){const s=a(t);return r.getItem(s)||e}static getInt(t,e){const s=a(t),i=r.getItem(s);if(null==i)return e;const n=parseInt(i,10);return isNaN(n)?e:n}static getFloat(t,e){const s=a(t),i=r.getItem(s);if(null==i)return e;const n=parseFloat(i);return isNaN(n)?e:n}static getBool(t,e){const s=a(t),i=r.getItem(s);return"true"===i||"false"!==i&&e}static getObject(t,e){const s=a(t),i=r.getItem(s);try{if(null!=i)return JSON.parse(i)}catch(t){console.error(t)}return e}static put(t,e){const s=a(t);return r.setItem(s,e),!0}static putObject(t,e){const s=a(t);return r.setItem(s,JSON.stringify(e)),!0}}},5285:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s="undefined"!=typeof btoa?btoa:function(t){return(t instanceof Buffer?t:Buffer.from(t.toString(),"binary")).toString("base64")},i="undefined"!=typeof atob?atob:function(t){return new Buffer(t,"base64").toString("binary")};e.default=class{static hex(t,e=2){const s=t.toString(16),i=s.length-e;if(i>0)return s.substring(i);if(0===i)return s;const r="0000000";return r.substring(r.length+i)+s}static clamp(t,e,s){return s<e||t<e?e:t>s?s:t}static getExt(t){const e=t.lastIndexOf(".");return e>=0?t.slice(e+1):""}static convertUint8ArrayToBase64String(t){const e=Array.from(t).map((t=>String.fromCharCode(t))).join("");return s(e)}static convertBase64StringToUint8Array(t){const e=i(t),s=new Array(e.length);for(let t=0;t<e.length;++t)s[t]=e.charCodeAt(t);return new Uint8Array(s)}}},1858:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Z_MENU_SUBITEM=e.Z_MENUBAR=void 0,e.Z_MENUBAR=1e3,e.Z_MENU_SUBITEM=e.Z_MENUBAR+1},8982:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(3104),r=s(2772),n=s(5525);function a(t,e,s){t.getRootNode().style.zIndex=String(s-1-e+100)}e.default=class{constructor(t){this.root=t,this.windows=[],this.keyboardManager=new r.default,this.blurred=!1,this.rafId=0,this.onKeyDown=t=>{t.ctrlKey&&"KeyW"===t.code?this.windows.length>0&&this.windows[0].close():t.ctrlKey||t.altKey||t.metaKey||(t.preventDefault(),this.keyboardManager.onKeyDown(t))},this.onKeyUp=t=>{t.preventDefault(),this.keyboardManager.onKeyUp(t)},this.root.addEventListener("keydown",this.onKeyDown),this.root.addEventListener("keyup",this.onKeyUp),this.setUpBlur(),this.setFocus()}setFocus(){this.root.focus()}isBlur(){return this.blurred}getKeyboardManager(){return this.keyboardManager}add(t){this.windows.length>0&&this.windows[0].onEvent(10,!1),this.windows.unshift(t),this.root.appendChild(t.getRootNode()),this.updateWindowPriorities(),1===this.windows.length&&this.startLoopAnimation()}remove(t){this.removeWnd(t);const e=t.getRootNode();null!=e&&null!=e.parentNode&&e.parentNode.removeChild(e),this.windows.length<=0&&this.cancelLoopAnimation()}async showSnackbar(t,e={}){const s=e.wait||3e3,r=e.type||"danger",n=document.createElement("div");n.className="snackbar-container",n.style.zIndex="10000";const a=document.createElement("div");a.className=`snackbar-box ${r}`,n.appendChild(a);const o=document.createTextNode(t);a.appendChild(o),this.root.appendChild(n),await i.default.timeout(20),n.style.top="8px",await i.default.timeout(s),n.style.top="-32px",await i.default.timeout(500),this.root.removeChild(n)}moveToTop(t){const e=this.windows.length;if(e>0&&this.windows[0]===t)return;this.windows[0].onEvent(10,!1);let s=t;for(let i=0;i<e;++i){const e=this.windows[i];if(this.windows[i]=s,e===t)break;s=e}this.updateWindowPriorities(),t.onEvent(10,!0)}isTop(t){return this.windows.length>0&&this.windows[0]===t}moveToCenter(t){const e=this.root.getBoundingClientRect(),s=t.getWindowSize();t.setPos((e.width-s.width)/2,(e.height-s.height)/2)}setFullscreen(t,e){if(!n.default.fullscreenEnabled)return!1;n.default.requestFullscreen(t);const s=()=>{const i=null!=n.default.fullscreenElement;i?(t.setAttribute("tabindex","1"),t.style.cursor="none",t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)):(t.removeAttribute("tabindex"),t.style.cursor="",t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp)),e&&e(i),i?t.focus():(n.default.removeEventListener("fullscreenchange",s,!1),this.setFocus())};return n.default.addEventListener("fullscreenchange",s,!1),!0}getRootClientRect(){return this.root.getBoundingClientRect()}removeWnd(t){const e=this.windows.indexOf(t);e<0||(this.windows.splice(e,1),0===e&&this.windows.length>0&&this.windows[0].onEvent(10,!0),this.updateWindowPriorities())}updateWindowPriorities(){const t=this.windows.length;for(let e=0;e<t;++e){const s=this.windows[e];s.setTop(0===e),a(s,e,t)}}setUpBlur(){window.addEventListener("focus",(()=>{this.blurred=!1})),window.addEventListener("blur",(()=>{this.blurred=!0,this.keyboardManager.clear()}))}startLoopAnimation(){if(0!==this.rafId)return;let t=window.performance.now();const e=()=>{const s=window.performance.now(),i=s-t;t=s;for(let t=0;t<this.windows.length;++t)this.windows[t].onEvent(0,i);this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}cancelLoopAnimation(){0!==this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=0)}}},748:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(3104),r=s(734),n=s(1858);class a{constructor(t,e,s,i){this.wndMgr=t,this.clientMarginWidth=0,this.clientMarginHeight=0,this.root=this.createRoot(),this.root.className="wnd",this.root.style.position="absolute";const[n,o]=r.default.createHorizontalSplitter(this.root,a.TITLEBAR_HEIGHT);this.clientMarginHeight+=a.TITLEBAR_HEIGHT;const{titleBar:h,titleBtnHolder:l,titleElem:c}=this.createTitleBar(i);this.titleBar=h,this.titleBtnHolder=l,this.titleElem=c,n.appendChild(this.titleBar),this.contentHolder=o,this.setClientSize(e,s)}setContent(t){return i.default.removeAllChildren(this.contentHolder),this.contentHolder.appendChild(t),this}getContentHolder(){return this.contentHolder}getRootElement(){return this.root}setPos(t,e){return i.default.setStyles(this.root,{left:`${t}px`,top:`${e}px`}),this}setTitle(t){return this.titleElem.innerText=t,this}setClientSize(t,e){return i.default.setStyles(this.root,{width:`${t+this.clientMarginWidth}px`,height:`${e+this.clientMarginHeight}px`}),this}getWindowSize(){return{width:parseInt(this.root.style.width||"-1",10),height:parseInt(this.root.style.height||"-1",10)}}onEvent(t,e){}isTop(){return this.wndMgr.isTop(this)}setTop(t){t?this.root.classList.add("top"):this.root.classList.remove("top")}addMenuBar(t){const[e,s]=r.default.createHorizontalSplitter(this.root,a.MENUBAR_HEIGHT);this.clientMarginHeight+=a.MENUBAR_HEIGHT,this.contentHolder.appendChild(e),this.contentHolder.appendChild(s),this.menuBar=document.createElement("div"),this.menuBar.className="menu-bar",this.menuBar.style.zIndex=String(n.Z_MENUBAR);const i=[];let o,h=-1;const l=()=>{h>=0&&(i[h].classList.remove("opened"),h=-1),o=null,this.onEvent(6)},c=e=>{const s=t[e];if(!("submenu"in s)||h===e)return;null!=o&&o(),h>=0&&i[h].classList.remove("opened");const n=i[e];h=e;const a=r.default.getOffsetRect(this.root,n),c={left:a.left-1+"px",top:a.bottom-1+"px"},u={className:"menu-subitem-holder",onClose:l};o=r.default.openSubmenu(s,c,this.root,u),n.classList.add("opened")};return t.forEach(((t,e)=>{const s=document.createElement("div");s.className="menu-item pull-left",s.innerText=t.label,s.style.height="100%",s.addEventListener("click",(s=>{s.stopPropagation(),"submenu"in t&&(h<0?(this.onEvent(5),c(e)):(o&&o(),l()))})),this.menuBar.appendChild(s),i.push(s),s.addEventListener("mouseenter",(s=>{h>=0&&h!==e&&"submenu"in t&&c(e)}))})),e.appendChild(this.menuBar),this.contentHolder=s,this}getRootNode(){return this.root}close(){!1!==this.onEvent(1)&&this.wndMgr.remove(this)}addResizeBox(){this.root.classList.add("resizable"),this.addTitleButton(this.titleBtnHolder,"maximize",(()=>{this.maximize()})),r.default.makeResizable(this.root,(()=>this.wndMgr.getRootClientRect()),((t,e)=>{switch(t){case 7:this.wndMgr.moveToTop(this),this.root.style.transitionProperty="none";break;case 9:this.root.style.transitionProperty=""}this.onEvent(t,e)}))}maximize(){this.setPos(0,0);const t=null!=this.menuBar?a.MENUBAR_HEIGHT:0,e=this.wndMgr.getRootClientRect(),s=e.width-2,i=e.height-(a.TITLEBAR_HEIGHT+t)-2;this.setClientSize(s,i)}createRoot(){const t=document.createElement("div");return t.addEventListener("mousedown",(t=>(0===t.button&&(t.stopPropagation(),this.wndMgr.moveToTop(this)),!1))),t}createTitleBar(t){const e=document.createElement("div");e.className="title-bar";const s=this.addTitle(e,t),i=document.createElement("div");return i.className="title-btn-holder",e.appendChild(i),this.addTitleButton(i,"close",(()=>{this.close()})),r.default.makeDraggable(this.root,e,(()=>this.wndMgr.getRootClientRect()),((t,e)=>{switch(t){case 2:this.root.style.transitionProperty="none";break;case 4:this.root.style.transitionProperty=""}this.onEvent(t,e)})),{titleBar:e,titleBtnHolder:i,titleElem:s}}addTitleButton(t,e,s){const i=document.createElement("div");return i.className=`${e} btn`,i.title=e,i.addEventListener("click",s),i.addEventListener("mousedown",(t=>{t.preventDefault(),t.stopPropagation()})),t.appendChild(i),i}addTitle(t,e){const s=document.createElement("div");return s.className="title",s.appendChild(document.createTextNode(e)),t.appendChild(s),s}}e.default=a,a.TITLEBAR_HEIGHT=20,a.MENUBAR_HEIGHT=14},734:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(3104),r=s(5285),n=s(1858),a=s(748);e.default=class{static getOffsetRect(t,e){const s=t.getBoundingClientRect(),i=e.getBoundingClientRect();return{left:i.left-s.left,top:i.top-s.top,right:i.right-s.left,bottom:i.bottom-s.top}}static createHorizontalSplitter(t,e){const s=document.createElement("div");s.className="upper",i.default.setStyles(s,{position:"absolute",overflow:"hidden",left:0,top:0,right:0,height:`${e}px`});const r=document.createElement("div");return r.className="lower",i.default.setStyles(r,{position:"absolute",overflow:"hidden",left:0,bottom:0,right:0,top:`${e}px`}),t.appendChild(s),t.appendChild(r),[s,r]}static makeDraggable(t,e,s,n){e.addEventListener("mousedown",(e=>{if(0!==e.button)return!1;n(2);const a=s();e.preventDefault();const[o,h]=i.default.getMousePosIn(e,t),l=-o,c=-h,u=parseInt(t.style.width||"-1",10),d=parseInt(t.style.height||"-1",10),p={x:o,y:h};return i.default.setMouseDragListener({move:e=>{const[s,o]=i.default.getMousePosIn(e,t.parentNode);p.x=r.default.clamp(s+l,0,Math.floor(a.width-u)),p.y=r.default.clamp(o+c,0,Math.floor(a.height-d)),i.default.setStyles(t,{left:`${Math.round(p.x)}px`,top:`${Math.round(p.y)}px`}),n(3,p)},up:t=>{n(4)}}),!0}))}static makeResizable(t,e,s){const n=60+a.default.TITLEBAR_HEIGHT;[{styleParams:{right:"-1px",bottom:"-1px",cursor:"nwse-resize"},horz:"right",vert:"bottom"},{styleParams:{left:"-1px",bottom:"-1px",cursor:"nesw-resize"},horz:"left",vert:"bottom"},{styleParams:{right:"-1px",top:"-1px",cursor:"nesw-resize"},horz:"right",vert:"top"},{styleParams:{left:"-1px",top:"-1px",cursor:"nwse-resize"},horz:"left",vert:"top"},{styleParams:{left:"8px",right:"8px",top:"-4px",cursor:"ns-resize"},horz:"center",vert:"top"},{styleParams:{left:"8px",right:"8px",bottom:"-1px",cursor:"ns-resize"},horz:"center",vert:"bottom"},{styleParams:{top:"8px",bottom:"8px",left:"-1px",cursor:"ew-resize"},horz:"left",vert:"center"},{styleParams:{top:"8px",bottom:"8px",right:"-1px",cursor:"ew-resize"},horz:"right",vert:"center"}].forEach((o=>{const h=document.createElement("div");h.className="resize-box",Object.keys(o.styleParams).forEach((t=>{h.style[t]=o.styleParams[t]})),i.default.setStyles(h,{width:"center"!==o.horz?"8px":void 0,height:"center"!==o.vert?"8px":void 0,zIndex:"2000"}),h.addEventListener("mousedown",(l=>{if(0!==l.button)return!1;l.stopPropagation(),l.preventDefault();const c=e(),[u,d]=i.default.getMousePosIn(l,h),p="left"===o.horz?-u:8-u,g="top"===o.vert?-d:8-d,f=t.getBoundingClientRect(),m=t.parentNode.getBoundingClientRect(),b={left:f.left-m.left,top:f.top-m.top,right:f.right-m.left,bottom:f.bottom-m.top,center:0};s(7);const k={width:b.right-b.left-2,height:b.bottom-b.top-2};return i.default.setMouseDragListener({move:e=>{let[h,l]=i.default.getMousePosIn(e,t.parentNode);h=r.default.clamp(h,-p,c.width-p),l=r.default.clamp(l,-g,c.height-g),b[o.horz]=h+p,b[o.vert]=l+g;let u=b.right-b.left-2,d=b.bottom-b.top-2;u<80&&(b[o.horz]-=(80-u)*("left"===o.horz?1:-1),u=80),d<n&&(b[o.vert]-=(n-d)*("top"===o.vert?1:-1),d=n),i.default.setStyles(t,{width:`${Math.round(b.right-b.left-2)}px`,height:`${Math.round(b.bottom-b.top-2)}px`,left:`${Math.round(b.left)}px`,top:`${Math.round(b.top)}px`}),k.width=u,k.height=d-a.default.TITLEBAR_HEIGHT,s(8,k)},up:t=>{s(9)}}),!0})),t.appendChild(h)}))}static openSubmenu(t,e,s,r){const a=document.createElement("div");null!=r.className&&(a.className=r.className),a.style.zIndex=String(n.Z_MENU_SUBITEM),t.submenu.forEach((t=>{const e=document.createElement("div");e.className="submenu-row clearfix";const s=document.createElement("div");if("----"!==t.label){let i=t.checked;if("function"==typeof t.checked&&(i=t.checked()),i){const t=document.createElement("div");t.className="submenu-check",e.appendChild(t)}s.innerText=t.label;let r=t.disabled;"function"==typeof t.disabled&&(r=t.disabled()),r?(s.className="menu-item disabled",e.addEventListener("click",(t=>{t.stopPropagation()}))):(s.className="menu-item",e.addEventListener("click",(e=>{t.click&&t.click()})))}else{const t=document.createElement("hr");t.className="submenu-splitter",e.style.padding="4px 0",e.addEventListener("click",(t=>{t.stopPropagation()})),e.appendChild(t)}e.appendChild(s),a.appendChild(e)})),s.appendChild(a),i.default.setStyles(a,e);const o=()=>{null!=a.parentNode&&a.parentNode.removeChild(a),document.removeEventListener("click",h)},h=t=>{o(),null!=r.onClose&&r.onClose()};return document.addEventListener("click",h),o}}}},__webpack_module_cache__={};function __webpack_require__(t){if(__webpack_module_cache__[t])return __webpack_module_cache__[t].exports;var e=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t].call(e.exports,e,e.exports,__webpack_require__),e.exports}__webpack_require__.m=__webpack_modules__,__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={179:0},e=[[8519,647]],s=()=>{};function i(){for(var s,i=0;i<e.length;i++){for(var r=e[i],n=!0,a=1;a<r.length;a++){var o=r[a];0!==t[o]&&(n=!1)}n&&(e.splice(i--,1),s=__webpack_require__(__webpack_require__.s=r[0]))}return 0===e.length&&(__webpack_require__.x(),__webpack_require__.x=()=>{}),s}__webpack_require__.x=()=>{__webpack_require__.x=()=>{},n=n.slice();for(var t=0;t<n.length;t++)r(n[t]);return(s=i)()};var r=i=>{for(var r,n,[o,h,l,c]=i,u=0,d=[];u<o.length;u++)n=o[u],__webpack_require__.o(t,n)&&t[n]&&d.push(t[n][0]),t[n]=0;for(r in h)__webpack_require__.o(h,r)&&(__webpack_require__.m[r]=h[r]);for(l&&l(__webpack_require__),a(i);d.length;)d.shift()();return c&&e.push.apply(e,c),s()},n=self.webpackChunknesemu=self.webpackChunknesemu||[],a=n.push.bind(n);n.push=r})(),__webpack_require__.x()})();